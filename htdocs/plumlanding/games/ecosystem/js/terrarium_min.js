function AnimatedText(e,t,i){var s,n,a,o=30,r=-1,l=i,d=t,h=[],u=["Make sure the animals have enough to eat for 12 days &#8211; some eat plants, some eat other animals.","To play, drag 5 plants or animals from these bubbles each day.","[insert] these lights to find out more about each one.","Move around with these arrows.","Start when you are ready."];this.text_anim_active=!1,this.par_stage=e,this.buildAnimatedText=function(){s=document.createElement("div"),s.id="animtxt_block",$(s).addClass("pos_abs"),n=document.createElement("span"),$(n).addClass("game-blurb"),s.appendChild(n),d.appendChild(s),a=new l.DOMElement(s),this.par_stage.addChild(a),a.x=100,a.y=220,$(s).hide()},this.readouttext=function(e){n.innerHTML=plumlib.TickerText.addBreaks(e,o),this.typetext(n),$(s).show()},this.typetext=function(e){var t=new plumlib.TickerText(e.innerHTML);h.push([e,t,t.untaggedlength(),0]),e.innerHTML="",this.text_anim_active=!0},this.nextIntroAnimatedText=function(e,t){var i,a,o,l="[insert]";++r,i=u[r],o=i.indexOf(l),-1!==o&&(a=e?"Tap":"Click",i=a+i.slice(o+l.length)),t?(n.innerHTML=i,$(s).show()):this.readouttext(i)},this.animateText=function(){if(h.length>0){var e=0,t=h[e];t[2]>t[3]?(t[3]+=1,t[0].innerHTML=t[1].subticker(0,t[3])):h.splice(e,1)}else this.text_anim_active=!1},this.hideAnimatedText=function(){$(s).hide()},this.buildAnimatedText()}function ArrowNavigation(e,t){var i,s,n,a,o="#6d44ac",r=t;this.cont_nav=new r.Container,this.game_position="",this.arrow_cover=new r.Shape,this.sctween_start="",this.par_stage=e,this.buildArrowNavigation=function(){this.cont_nav.x=938,this.cont_nav.y=300,this.cont_nav.visible=!1,this.par_stage.addChild(this.cont_nav),nav_bg=new lib.tpanel(50,95),nav_bg.x=0,nav_bg.y=0,this.cont_nav.addChild(nav_bg),i=new lib.toucharrow,i.rotation=180,i.x=25,i.y=25,i.name="left",this.cont_nav.addChild(i),s=new lib.toucharrow,s.x=25,s.y=70,s.name="right",this.cont_nav.addChild(s),n=new lib.toucharrow,n.rotation=270,n.x=25,n.y=25,n.name="top",this.cont_nav.addChild(n),a=new lib.toucharrow,a.rotation=90,a.x=25,a.y=70,a.name="bottom",this.cont_nav.addChild(a),this.arrow_cover.graphics.beginFill(o).drawRect(0,0,50,95).endFill(),this.arrow_cover.alpha=.5,this.cont_nav.addChild(this.arrow_cover),this.arrow_cover.visible=!1},this.setArrowNavigation=function(e){"horz"===e?(n.visible=!1,a.visible=!1,this.game_position="left",i.addEventListener("click",this.activateButton.bind(this),!1),s.addEventListener("click",this.activateButton.bind(this),!1)):(i.visible=!1,s.visible=!1,this.game_position="top",n.addEventListener("click",this.activateButton.bind(this),!1),a.addEventListener("click",this.activateButton.bind(this),!1)),this.setArrowDisplay()},this.setArrowDisplay=function(){switch(this.game_position){case"left":i.alpha=.4,i.cursor="default",s.alpha=1,s.cursor="pointer";break;case"right":s.alpha=.4,s.cursor="default",i.alpha=1,i.cursor="pointer";break;case"top":n.alpha=.4,n.cursor="default",a.alpha=1,a.cursor="pointer";break;case"bottom":a.alpha=.4,a.cursor="default",n.alpha=1,n.cursor="pointer"}this.par_stage.update()},this.activateButton=function(e){var t=e.target;1===t.alpha&&(this.game_position=e.currentTarget.name,$.event.trigger({type:"SLIDE_BACKGROUND"}))},this.buildArrowNavigation()}function AudioManager(e){var t=1,i=e,s=[],n=[];this.gamesounds,this.sounds_loaded=!1,this.remove_sounds=!0,this.sync_char,this.initAudioManager=function(){useragent=plumlogin.getBrowserInfo(),t="ie"===useragent.browser?swfobject.hasFlashPlayerVersion("9")?1:useragent.bversion<10?3:2:1,console.log("*********\nPLUMLOGIN RESULT getBrowserInfo["+useragent.browser+"] swfobject.flash["+swfobject.hasFlashPlayerVersion("9")+"] introsSounds["+s[0]+"] \n*********"),$(document).on("soundLoaded",this.audioLoadComplete.bind(this)),this.gamesounds=new plumlib.CharacterSound(i[0].audio,i[0].sync)},this.audioLoadComplete=function(){if("preload"===i[0].type&&(s.push.apply(s,this.gamesounds.soundlist),"preload"!==i[1].type&&(this.sounds_loaded=!0)),i.splice(0,1),0===i.length)return void(i=null);switch(i[0].type){case"preload":this.gamesounds.loadAdditionalSounds(i[0].audio,i[0].sync);break;case"load":$(document).off("soundLoaded"),this.gamesounds.loadAdditionalSounds(i[0].audio,i[0].sync),i.splice(0,1);break;case"level2":3!==t&&this.gamesounds.loadAdditionalSounds(i[0].audio,i[0].sync),$(document).off("soundLoaded"),i=null,s=null}},this.soundsRemoved=function(){$(document).off("soundsRemoved"),s=[],$(document).on("soundLoaded",this.audioLoadComplete.bind(this)),this.gamesounds.loadAdditionalSounds(i[0].audio,i[0].sync)},this.removeIntroSounds=function(){this.remove_sounds=!1,$(document).on("soundsRemoved",this.soundsRemoved.bind(this)),this.gamesounds.removeSounds(s)},this.playAudioSeq=function(e,t,i){n=e.split(","),i&&this.sync_char.startPlumSync(),n.length>1?this.gamesounds.playSounds(n,t):this.gamesounds.playSound(n,t)},this.playSFXSound=function(e){this.gamesounds.playSFX(e)},this.stopAllSounds=function(){this.gamesounds.stopSound()},this.isSoundAvailable=function(e){return this.gamesounds.soundReady(e)},this.initAudioManager()}function CharacterInfoBox(e,t,i,s,n){var a,o,r,l,d,h,u,c=246,g="These are healthy!",p="Uhoh! Not so healthy!",m="You need to add this!",_="Bubbles left!",b="Bubble left!",v=218,f=278,w=128,y=44,x=20,S=222,C=162,A=312,k=0,E=60,T=-90,L=3,R=s,O=n,B=new O.Shape,N=new O.Shape,M=new O.Container,I=new O.Shape,D=new O.Container,P=new O.Shape,Y=new O.Shape,F=new O.Shape,q=c/2,W=0,X=0,G="",H=t,j=i;this.cont_box=new O.Container,this.gl_open_char=!1,this.par_stage=e,this.buildBox=function(){var e,t=21,i=217,s=51,n=35,a=new O.Shape,g=q-s/2;this.cont_box.y=S,this.cont_box.addChild(M),M.addChild(B),M.addChild(N),M.mask=I,G="reg",this.resizeBackground(v,S,k),N.graphics.beginFill(PUR_COLOR).drawRect(0,0,c,y).endFill(),a.graphics.setStrokeStyle(1).beginStroke("#6a51c2").drawCircle(38,101,16).endStroke(),this.cont_box.addChild(a),Y.graphics.setStrokeStyle(1.5).beginStroke(BDR_COLOR).moveTo(3,128).lineTo(243,128).endStroke(),this.cont_box.addChild(Y),e=P.graphics,e.setStrokeStyle(1).beginStroke(BDR_COLOR).beginFill(WHT_COLOR).moveTo(g+s,i).lineTo(q,i+n).lineTo(g,i).endFill().endStroke(),this.cont_box.addChild(P),o=new lib.gametext("","h7"),o.y=t,o.textBaseline="middle",this.cont_box.addChild(o),r=new lib.gametext(m,".game-blurb-caption"),r.x=62,r.y=64,r.textBaseline="middle",this.cont_box.addChild(r),d=new lib.gametext("0",".game-blurb-caption-bold"),d.x=38,d.y=100,d.textAlign="center",d.textBaseline="middle",this.cont_box.addChild(d),l=new lib.gametext(_,".game-blurb-caption"),l.x=62,l.y=100,l.textBaseline="middle",this.cont_box.addChild(l),h=new lib.gametext("What it eats",".game-blurb-caption-bold"),h.x=123,h.y=146,h.textAlign="center",h.textBaseline="middle",this.cont_box.addChild(h),u=new lib.LifeStatus(GRN_COLOR,RED_COLOR,GRAY_COLOR),u.x=22,u.y=54,u.displayLite("none"),this.cont_box.addChild(u),D.y=188,this.cont_box.addChild(D),F.x=0,F.y=0,this.hideBox(),this.par_stage.addChild(this.cont_box),this.par_stage.addChild(F),F.graphics.beginFill(WHT_COLOR).drawRect(0,0,H,j-R).endFill(),F.alpha=.01,F.addEventListener("click",this.activateCloseBox.bind(this),!1),this.par_stage.update()},this.activateCloseBox=function(){this.hideBox(),$.event.trigger({type:"RESET_TIMER"})},this.resizeBackground=function(e,t,i){B.graphics.clear(),I.graphics.clear(),B.graphics.beginFill(WHT_COLOR).drawRect(0,0,c,e).endFill(),I.graphics.beginFill(MASK_COLOR).drawRoundRect(0,0,c,e,x).endFill(),P.y=i,this.cont_box.y=t},this.showBox=function(e){switch(o.text=e.fullname,o.x=(c-o.getMeasuredWidth())/2,e.status){case"well":u.displayLite("well"),r.text=g;break;case"hungry":u.displayLite("hungry"),r.text=p;break;default:u.displayLite("none"),r.text=m}d.text=String(e.num),l.text=e.num>1||0===e.num?_:b,0!==e.food.length?(D.getNumChildren()>0&&D.removeChildAt(0),D.addChild(e.foodicons),a=D.getChildAt(0).getBounds(),D.x=q-a.width/2,D.visible=!0,h.visible=!0,Y.visible=!0,e.food.length<=L?"reg"!==G&&(G="reg",this.resizeBackground(v,S,k)):"long"!==G&&(G="long",this.resizeBackground(f,C,E))):(D.visible=!1,h.visible=!1,Y.visible=!1,"short"!==G&&(G="short",this.resizeBackground(w,A,T))),W=e.origX-q,X=W+c,0>W?(P.x=W,W=0):X>H?(P.x=X-H,W=H-c):P.x=0,this.gl_open_char=!0,this.cont_box.x=W,this.cont_box.visible=!0,F.visible=!0},this.hideBox=function(){this.gl_open_char=!1,F.visible=!1,this.cont_box.visible=!1,this.par_stage.update()},this.buildBox()}function FoodSource(e,t){this.name=e,this.amt=t}function GameBackgrounds(e,t,i,s,n,a){var o,r,l,d=t,h=2,u=0,c=e,g=s,p=n,m=i,_=a;this.bg_bounds,this.sctween_amtX=0,this.sctween_amtY=0,this.bmp_bgday,this.par_stage,this.backgrounds_loaded=!1,this.tween_bg=!1,this.loadBackgroundImages=function(){o=new Image,o.src=d+"terrarium-"+c+"-bg-day.jpg",o.name="day",o.addEventListener("load",this.imageLoaded.bind(this),!1),r=new Image,r.src=d+"terrarium-"+c+"-bg-night.jpg",r.name="night",r.addEventListener("load",this.imageLoaded.bind(this),!1)},this.imageLoaded=function(e){e.target.removeEventListener("load",this.imageLoaded);var t=new _.Bitmap(e.target);"day"===e.target.name?(this.bmp_bgday=t,m.addChild(this.bmp_bgday),++u):(l=t,l.alpha=0,m.addChild(l),++u),u===h&&(m.visible=!0,this.bg_bounds=m.getBounds(),this.backgrounds_loaded=!0,this.sctween_amtX=-(this.bg_bounds.width-g),this.sctween_amtY=-(this.bg_bounds.height-p),this.par_stage.update())},this.switchToNightView=function(){this.tween_bg=!0,_.Tween.get(l).to({alpha:1},300),_.Tween.get(this.bmp_bgday).to({alpha:0},300).call(this.tweenDone.bind(this)),this.par_stage.update()},this.switchToDayView=function(){this.tween_bg=!0,_.Tween.get(l).to({alpha:0},300),_.Tween.get(this.bmp_bgday).to({alpha:1},300).call(this.tweenDone.bind(this)),this.par_stage.update()},this.tweenDone=function(){this.tween_bg=!1},this.loadBackgroundImages()}function GameControls(e,t,i,s){var n=t;this.header_text,this.restart_bt,this.par_stagemsg=e,this.par_stageui=i,this.buildGeneralGameControls=function(){this.header_text=new lib.gametext("Add 5 bubbles","h3"),this.header_text.x=20,this.header_text.y=28,this.header_text.textBaseline="middle",n.addChild(this.header_text),this.par_stagemsg.update(),this.restart_bt=new lib.terr_startbutton(PUR_COLOR),this.restart_bt.x=924,this.restart_bt.y=8,this.restart_bt.cursor="pointer",this.restart_bt.addEventListener("click",function(){$.event.trigger({type:"RESTART_SELECTED"})}),this.par_stageui.addChild(this.restart_bt)},this.buildGeneralGameControls()}function InactivityTimer(){var e,t=900;this.active_timer=!1,this.par_audiomgr,this.activateTimer=function(){e=t,this.active_timer=!0},this.resetTimer=function(){e=t},this.updateTimer=function(){--e,0>=e&&(this.active_timer=!1,this.par_audiomgr.isSoundAvailable("idle")?this.par_audiomgr.playAudioSeq("idle","start_timer",!1):$.event.trigger({type:"soundEnded",message:"start_timer"}),e=t)},this.deactivateTimer=function(){this.active_timer=!1}}function IntroArrows(e,t,i){var s,n,a=t,o=document.getElementById(i),r=[{src:a+"arrow_bubbles.png",x:449,y:272},{src:a+"arrow_lights.png",x:445,y:270},{src:a+"arrow_arrows.png",x:452,y:260}];this.buildIntroArrows=function(){for(n=document.createElement("div"),o.appendChild(n),e(n).addClass("pos_abs"),e(n).hide(),s=0;s<r.length;++s){var t=new Image;t.src=r[s].src,e(t).addClass("pos_abs"),e(t).css("left",r[s].x),e(t).css("top",r[s].y),e(t).hide(),n.appendChild(t),r[s].obj=t}},this.showIntroArrow=function(){null!==r&&(e(n).show(),e(r[0].obj).is(":visible")&&(e(r[0].obj).remove(),r.splice(0,1)),e(r[0].obj).show())},this.clearIntroArrows=function(){if(null!==r){for(s=0;s<r.length;++s)e(r[s].obj).remove();r=null,e(n).remove()}},this.buildIntroArrows()}function LoaderSplash(e,t,i,s,n,a){var o,r,l,d,h=t,u=s,c=n,g=a,p=document.getElementById(i),m=new Image;this.par_stage,this.load_overlay,this.initialize=function(){r=document.createElement("div"),r.id="loading",r.innerHTML='<div id="spinner"><div class="text"><div id="bar">&nbsp;</div><span class="words">Loading</span></div></div>',p.appendChild(r),l=document.getElementById("bar"),this.updateLoadbar(.1),o=document.createElement("A"),o.id="playbtn",e(o).addClass("pos_abs"),o.appendChild(m),p.appendChild(o),e(o).hide(),d=document.createElement("A"),d.id="loginbtn",d.innerHTML="Login",e(d).addClass("btn"),e(d).addClass("pos_abs"),e(d).css("right","30%"),e(d).css("bottom","16px"),p.appendChild(d),e(d).hide()},this.updateLoadbar=function(t){t=parseInt(100*t),0===t&&(t=.1),e(l).css("width",t+"%")},this.launchStartButton=function(){e(r).hide(),m.src=h+"playbutton.png",e(o).css("width","178px"),e(o).css("height","149px"),e(o).css("left",u/2-89),e(o).css("bottom","6px"),e(o).show(),o.addEventListener("click",this.buttonClick.bind(this),!1)},this.isSplashVisible=function(){return e(o).is(":visible")},this.showLogin=function(){e(d).show(),d.addEventListener("click",this.buttonClick.bind(this),!1)},this.hideLogin=function(){e(d).hide(),d.removeEventListener("click")},this.buttonClick=function(t){switch(t.currentTarget.id){case"playbtn":e(o).remove(),e(d).remove(),e("#splashimg").remove(),this.triggerMessageEvent("START_WELCOME");break;case"loginbtn":e(d).hide(),this.triggerMessageEvent("LAUNCH_LOGIN")}},this.triggerMessageEvent=function(t){e.event.trigger({type:t})},this.addLoadingOverlay=function(e){this.par_stage=e,this.load_overlay=new g.Shape,this.load_overlay.graphics.beginFill(WHT_COLOR).drawRect(0,0,u,c).endFill(),this.load_overlay.alpha=.6,this.load_overlay.visible=!1,this.par_stage.addChild(this.load_overlay)},this.hideLoaderAnimation=function(){e("#loading").hide(),this.load_overlay.visible=!1,this.par_stage.update()},this.showLoaderAnimation=function(){this.load_overlay.visible=!0,this.par_stage.update(),this.updateLoadbar(.1),e("#loading").show()},this.initialize()}function PlacedCharacter(e,t,i,s,n,a,o,r,l,d){this.name=e,this.family=t,this.index=i,this.partial=s,this.freq=n,this.starve=a,this.life=1,this.last_ate=n,this.days_without=0,this.starving=!1,this.movement=o,this.region=r,this.id=l,this.shelter=d,this.flipped=!1,this.delay_counter,this.resting=!1,this.anim}function PlinkMessenger(e,t,i,s,n){var a,o,r,l,d,h,u,c,g,p,m,_,b,v,f,w,y,x,S,C,A,k,E,T,L=28,R=66,O=.7,B=7,N=264,M=5,I=10,D=14,P=18,Y=0,F=64,q=790,W=200,X=0,G=N,H=288,j=290,V=.25,z=.05,U=s,K=t,J=i,Q="These are healthy",Z="These are less healthy",et="These are gone",tt="",it="",st=n,nt=new st.Container,at=new st.Container,ot=new st.Container,rt=new st.Container,lt=new st.Container,dt=new st.Container,ht=new st.Container,ut=new st.Container,ct=!1,gt=!1,pt=!0;this.gl_open_intro=!1,this.gl_open_report=!1,this.gl_open_restart=!1,this.tween_ui_active=!1,this.intro_active=!1,this.current_score=0,this.species_well=[],this.species_hungry=[],this.species_lost=[],this.icon_sheet,this.nextday_bt,this.next_bt,this.par_audiomgr,this.par_stage=e,this.buildMessageDisplay=function(){var e,t,i,s,n=100,a=-70,o=-134,r=-155,k=-144,E=-80,T=-198,L=-12;nt.addChild(at),nt.addChild(ot),ot.x=q,ot.y=W,d=new lib.plinkscreen,at.addChild(d),e=new lib.plinkscreen_scaled(.75),ot.addChild(e),f=new lib.gametext("",".projection-subhead",DK_PUR_COLOR),f.x=D,f.y=a,f.textAlign="center",f.textBaseline="middle",rt.addChild(f),S=new lib.shinylight(GRN_COLOR,32,22),S.x=o,S.y=E,rt.addChild(S),C=new lib.shinylight(RED_COLOR,32,22),C.x=r,C.y=E,rt.addChild(C),A=new lib.shinylight(GRAY_COLOR,32,22),A.x=k,A.y=E,rt.addChild(A),lt.x=T,lt.y=L,rt.addChild(lt),l=new lib.scorebubble(GRN_COLOR,0),l.x=216,l.y=-206,rt.addChild(l),at.addChild(rt),ht.x=-210,ht.y=-70,ht.scaleX=ht.scaleY=.9,dt.addChild(ht),t=new lib.wordarrow(CYAN_COLOR),t.x=-42.5,t.y=-25,dt.addChild(t),w=new lib.gametext("NEEDS",".btn",WHT_COLOR),w.textBaseline="middle",w.x=-38,w.y=0,dt.addChild(w),y=new lib.gametext("EATS",".btn",WHT_COLOR),y.textBaseline="middle",y.x=-38,y.y=0,dt.addChild(y),dt.addChild(ut),at.addChild(dt),x=new lib.gametext("Here's how well you did after 12 days!",".game-blurb"),x.x=-216,x.y=-60,at.addChild(x),e.settitle("WAIT!"),i=new lib.gametext("Are you SURE you",".game-blurb"),i.y=-40,i.textAlign="center",s=new lib.gametext("want to start over?",".game-blurb"),s.y=0,s.textAlign="center",ot.addChild(i),ot.addChild(s),h=new st.Shape,u=new st.Shape,at.addChild(u),u.addEventListener("click",this.screenClick.bind(this)),c=new st.Shape,ot.addChild(c),c.addEventListener("click",this.screenClick.bind(this)),this.nextday_bt=new lib.buttonbg("Next Day",!0),this.nextday_bt.x=-(this.nextday_bt.width/2),this.nextday_bt.y=n,at.addChild(this.nextday_bt),this.next_bt=new lib.buttonbg("Next",!0),this.next_bt.x=-(this.next_bt.width/2),this.next_bt.y=n,at.addChild(this.next_bt),g=new lib.buttonbg("Play again",!1),g.x=44,g.y=36,at.addChild(g),p=new lib.buttonbg("Okay!",!1),p.x=-(p.width/2),p.y=n,at.addChild(p),m=new lib.buttonbg("Yes, start over.",!1),ot.addChild(m),m.x=-120,m.y=54,_=new lib.buttonbg("No",!1,PUR_COLOR),ot.addChild(_),_.x=54,_.y=54,b=new lib.buttonbg("Skip intro",!0),b.x=830,b.y=404,b.visible=!1,this.nextday_bt.cursor="pointer",this.nextday_bt.addEventListener("click",this.screenClick.bind(this)),this.next_bt.cursor="pointer",this.next_bt.addEventListener("click",this.screenClick.bind(this)),p.cursor="pointer",p.addEventListener("click",this.screenClick.bind(this)),g.cursor="pointer",g.addEventListener("click",this.screenClick.bind(this)),_.cursor="pointer",_.addEventListener("click",this.screenClick.bind(this)),m.cursor="pointer",m.addEventListener("click",this.callRestart.bind(this)),b.cursor="pointer",b.addEventListener("click",this.screenClick.bind(this)),h.graphics.beginFill(WHT_COLOR).drawRect(0,0,K,J).endFill(),h.alpha=.01,h.visible=!1,u.graphics.beginFill(WHT_COLOR).drawRect(-(K/2),-(J/2)+15,K,J-U).endFill(),u.alpha=.01,u.x=230,u.scaleX=1.12,c.graphics.beginFill(WHT_COLOR).drawRect(-q,-W,K,J-U).endFill(),c.alpha=.01,X=K/2,v=new lib.buttonbg("Next",!0),v.x=860,v.y=470,v.visible=!1,this.par_stage.addChild(v),this.par_stage.addChild(nt),this.par_stage.addChild(h),this.par_stage.addChild(b),this.hideAllContent(),nt.visible=!1,this.par_stage.update()},this.showWelcomeNextButton=function(){a="next_welcome",v.visible=!0,this.par_stage.update(),v.cursor="pointer",v.addEventListener("click",this.screenClick.bind(this))},this.hideAllContent=function(){rt.visible=!1,dt.visible=!1,this.nextday_bt.visible=!1,this.next_bt.visible=!1,x.visible=!1,g.visible=!1,p.visible=!1,at.visible=!1,ot.visible=!1},this.buildReportIconsArea=function(e,t){var i,s,n=-1,a=0;for(this.current_score=0,r=lt.getNumChildren()-1;r>=0;--r)lt.removeChildAt(0);for(i=0;i<e.length;++i)++n,n>=B&&(n=0,++a),s=this.buildEachIcon(e[i]),lt.addChild(s),s.x=n*R,s.y=a*R,this.current_score+=gt?2*t:t},this.showMessenger=function(e){this.par_audiomgr.isSoundAvailable("sfx_plinkopen")?this.par_audiomgr.playAudioSeq("sfx_plinkopen",tt,!1):$.event.trigger({type:"soundEnded",message:tt}),this.tween_ui_active=!0,at.scaleX=at.scaleY=V,nt.visible=!0,at.visible=!0,this.par_stage.update(),st.Tween.get(at).to({scaleX:e,scaleY:e},500,st.Ease.backOut).call(this.messengerTweenDone.bind(this))},this.hideMessenger=function(){this.par_audiomgr.isSoundAvailable("sfx_plinkclose")&&this.par_audiomgr.playSFXSound("sfx_plinkclose"),this.tween_ui_active=!0,this.tween_active=!0,this.par_stage.update(),st.Tween.get(at).to({scaleX:z,scaleY:z},300).call(this.messengerCloseTweenDone.bind(this)),this.gl_open_report=!1},this.showSmallMessenger=function(){this.par_audiomgr.isSoundAvailable("sfx_plinkopen")?this.par_audiomgr.playAudioSeq("sfx_plinkopen","speak_startover"):$.event.trigger({type:"soundEnded",message:"speak_startover"}),this.tween_ui_active=!0,ot.scaleX=ot.scaleY=V,nt.visible=!0,this.par_stage.update(),st.Tween.get(ot).to({scaleX:1,scaleY:1},500,st.Ease.backOut).call(this.messengerTweenDone.bind(this))},this.hideSmallMessenger=function(){this.par_audiomgr.isSoundAvailable("sfx_plinkclose")&&this.par_audiomgr.playSFXSound("sfx_plinkclose"),this.tween_ui_active=!0,this.par_stage.update(),st.Tween.get(ot).to({scaleX:z,scaleY:z},300).call(this.messengerCloseTweenDone.bind(this)),this.gl_open_restart=!1},this.buildEachIcon=function(e){var t=new st.Container,i=new lib.fuzzycircle(L,2,ICON_COLOR);t.addChild(i);var s=new createjs.Bitmap(this.icon_sheet._images[0]);return s.sourceRect=this.icon_sheet.getFrame(this.icon_sheet.getAnimation(e).frames[0]).rect,s.x=s.y=-L,s.scaleX=s.scaleY=O,t.addChild(s),t},this.messengerTweenDone=function(){this.tween_ui_active=!1,"intro_ready"===a&&(a="intro_done",b.visible=!0,this.par_stage.update(),T=window.setInterval(this.launchMissionAudio.bind(this),300)),"end_ready"===a&&this.triggerMessageEvent("SHOW_POINTS_ANIM"),at.visible&&"Daily Report"===d.gettitle()&&(this.par_audiomgr.isSoundAvailable(it)?this.par_audiomgr.playAudioSeq(it,"show_button",!1):$.event.trigger({type:"soundEnded",message:"show_button"}))},this.launchMissionAudio=function(){window.clearInterval(T),$.event.trigger({type:"soundEnded",message:"speak_mission"})},this.messengerCloseTweenDone=function(){this.gl_open_restart||this.gl_open_report||(this.tween_ui_active=!1,this.hideAllContent(),nt.visible=!1,this.par_stage.update(),this.finishTask())},this.screenClick=function(){if(!this.tween_ui_active)switch(a){case"next_welcome":this.triggerMessageEvent("STOP_WELCOME");break;case"next_lost":this.par_audiomgr.isSoundAvailable("sfx_plinkchange")&&this.par_audiomgr.playSFXSound("sfx_plinkchange"),this.next_bt.visible=!1,h.visible=!0,this.par_stage.update(),this.species_hungry.length>0?(f.text=Z,C.visible=!0,S.visible=!1,A.visible=!1,this.buildReportIconsArea(this.species_hungry,M),l.visible=!0,l.setNewAmount(this.current_score),this.triggerMessageEvent("SCORE_CHANGE"),f.x=P,a=this.species_well.length>0?"next":"nextday",this.par_stage.update(),pt?this.par_audiomgr.isSoundAvailable("lesshealthy2")?this.par_audiomgr.playAudioSeq("lesshealthy2","show_button",!1):$.event.trigger({type:"soundEnded",message:"show_button"}):(this.par_audiomgr.isSoundAvailable("lesshealthy2")&&this.par_audiomgr.playAudioSeq("lesshealthy2","",!1),T=window.setInterval(this.showWindowButton.bind(this),2e3))):(f.text=Q,C.visible=!1,S.visible=!0,A.visible=!1,this.buildReportIconsArea(this.species_well,I),l.visible=!0,l.setNewAmount(this.current_score),this.triggerMessageEvent("SCORE_CHANGE"),this.next_bt.visible=!1,a="nextday",f.x=D,this.par_stage.update(),pt?this.par_audiomgr.isSoundAvailable("goodjob_report")?this.par_audiomgr.playAudioSeq("goodjob_report","show_button",!1):$.event.trigger({type:"soundEnded",message:"show_button"}):(this.par_audiomgr.isSoundAvailable("goodjob_report")&&this.par_audiomgr.playAudioSeq("goodjob_report","",!1),T=window.setInterval(this.showWindowButton.bind(this),2e3)));break;case"next":h.visible=!0,this.par_stage.update(),this.par_audiomgr.isSoundAvailable("sfx_plinkchange")&&this.par_audiomgr.playSFXSound("sfx_plinkchange"),f.text=Q,C.visible=!1,S.visible=!0,A.visible=!1,this.buildReportIconsArea(this.species_well,I),l.visible=!0,l.setNewAmount(this.current_score),this.triggerMessageEvent("SCORE_CHANGE"),this.next_bt.visible=!1,a="nextday",f.x=D,this.par_stage.update(),pt?this.par_audiomgr.isSoundAvailable("goodjob_report")?this.par_audiomgr.playAudioSeq("goodjob_report","show_button",!1):$.event.trigger({type:"soundEnded",message:"show_button"}):(this.par_audiomgr.isSoundAvailable("goodjob_report")&&this.par_audiomgr.playAudioSeq("goodjob_report","",!1),T=window.setInterval(this.showWindowButton.bind(this),2e3));break;case"no_restart":pt?this.hideSmallMessenger():(this.gl_open_restart=!1,this.messengerCloseTweenDone(),this.par_audiomgr.isSoundAvailable("sfx_plinkchange")&&this.par_audiomgr.playSFXSound("sfx_plinkchange"));break;case"intro_done":this.triggerMessageEvent("END_INTRO");break;case"end_ready":this.par_audiomgr.isSoundAvailable("tinypause")?this.par_audiomgr.playAudioSeq("tinypause","play_again",!1):$.event.trigger({type:"soundEnded",message:"play_again"});break;case"nextday":case"restart":case"okay":this.par_audiomgr.stopAllSounds(),pt?this.hideMessenger():(this.gl_open_report=!1,this.messengerCloseTweenDone(),this.par_audiomgr.isSoundAvailable("sfx_plinkchange")&&this.par_audiomgr.playSFXSound("sfx_plinkchange"))}},this.finishTask=function(){switch(a){case"nextday":ct=!1,this.triggerMessageEvent("START_NEW_DAY");break;case"restart":ct=!1,this.triggerMessageEvent("RESTART_GAME");break;case"okay":this.triggerMessageEvent("ACTIVATE_TIMER");break;case"no_restart":ct&&(ct=!1,this.triggerMessageEvent("START_NEW_DAY"));break;case"intro_done":h.visible=!1,this.intro_active=!1;break;case"end_ready":this.triggerMessageEvent("RESTART_GAME")}},this.callRestart=function(){a="restart",pt?this.hideSmallMessenger():(this.gl_open_restart=!1,this.messengerCloseTweenDone(),this.par_audiomgr.isSoundAvailable("sfx_plinkchange")&&this.par_audiomgr.playSFXSound("sfx_plinkchange"))},this.showDailyReport=function(e,t){pt=e,gt=t,this.gl_open_report=!0,at.x=X,at.y=G,ct=!0,this.hideAllContent(),d.settitle("Daily Report"),this.species_lost.length>0?(it="allgone",f.text=et,A.visible=!0,C.visible=!1,S.visible=!1,this.buildReportIconsArea(this.species_lost,0),l.visible=!1,this.triggerMessageEvent("SCORE_CHANGE"),f.x=Y,a=this.species_hungry.length>0||this.species_well.length>0?"next_lost":"nextday"):this.species_hungry.length>0?(it="lesshealthy",f.text=Z,C.visible=!0,S.visible=!1,A.visible=!1,this.buildReportIconsArea(this.species_hungry,M),l.visible=!0,l.setNewAmount(this.current_score),this.triggerMessageEvent("SCORE_CHANGE"),f.x=P,a=this.species_well.length>0?"next":"nextday"):(it="goodjob_report",f.text=Q,C.visible=!1,S.visible=!0,A.visible=!1,this.buildReportIconsArea(this.species_well,I),l.visible=!0,l.setNewAmount(this.current_score),this.triggerMessageEvent("SCORE_CHANGE"),a="nextday",f.x=D),rt.visible=!0,tt="",pt?this.showMessenger(1):(at.scaleX=at.scaleY=1,at.visible=!0,nt.visible=!0,this.par_stage.update(),this.par_audiomgr.isSoundAvailable(it)&&this.par_audiomgr.playAudioSeq("sfx_plinkchange,tinypause,"+it,"",!1),T=window.setInterval(this.showWindowButton.bind(this),2e3))},this.showNeedsDialog=function(e,t,i,s){pt=e;var n="";for(this.gl_open_report=!0,at.x=X,at.y=G,E=null,E=i,o=t,k=s,this.intro_active&&(this.intro_active=!1),this.hideAllContent(),r=ut.getNumChildren()-1;r>=0;--r)ut.removeChildAt(0);switch(o){case"food":d.settitle("This needs food!"),ut.addChild(E.foodicons),w.visible=!1,y.visible=!0,tt="speak_needsfood",n="nofood";break;case"shelter":d.settitle("This needs the right home!"),ut.addChild(E.sheltericons),w.visible=!0,y.visible=!1,tt="speak_needshome",n="needshome";break;case"region":d.settitle("This is not its habitat!"),ut.addChild(s),w.visible=!0,y.visible=!1,tt="speak_needsregion",n="cantlivehere"}ut.x=F,ht.getNumChildren()>0&&ht.removeChildAt(0),ht.addChild(E.largeimg),p.visible=!0,a="okay",dt.visible=!0,pt?this.showMessenger(1):(this.par_audiomgr.stopAllSounds(),at.scaleX=at.scaleY=1,at.visible=!0,nt.visible=!0,this.par_stage.update(),this.par_audiomgr.isSoundAvailable(n)&&this.par_audiomgr.playAudioSeq("sfx_plinkchange,tinypause,"+n,"",!1))},this.showRestartDialog=function(e){pt=e,this.gl_open_restart=!0,this.hideAllContent(),a="restart",m.visible=!1,_.visible=!1,ot.visible=!0,pt?this.showSmallMessenger():(this.par_audiomgr.stopAllSounds(),ot.scaleX=ot.scaleY=1,ot.visible=!0,nt.visible=!0,this.par_stage.update(),this.par_audiomgr.isSoundAvailable("startover")&&this.par_audiomgr.playAudioSeq("sfx_plinkchange,tinypause,startover","",!1),T=window.setInterval(this.showWindowButton.bind(this),2e3))},this.showIntroduction=function(){this.gl_open_intro=!0,a="intro_ready",this.intro_active=!0,h.visible=!0,v.visible=!1,this.par_stage.update(),d.settitle("MISSION"),at.x=H,at.y=j,this.showMessenger(.9)},this.showIntroOkayBT=function(){p.visible=!0,b.visible=!1,h.visible=!1,this.par_stage.update()},this.startGameEndDisplay=function(){pt=!0,this.hideAllContent(),a="end_ready",tt="",at.x=H,at.y=j+75,x.visible=!0,d.settitle(""),this.showMessenger(.9)},this.showEndTitle=function(e){d.settitle(e),this.par_stage.update()},this.blockInteractions=function(){h.visible=!0,this.par_stage.update()},this.unblockInteractions=function(){h.visible=!1,this.par_stage.update()},this.closeOpenMessages=function(){at.visible?(a="",pt?this.hideMessenger():(this.gl_open_report=!1,this.messengerCloseTweenDone(),this.par_audiomgr.isSoundAvailable("sfx_plinkchange")&&this.par_audiomgr.playSFXSound("sfx_plinkchange"))):ot.visible&&(a="",pt?this.hideSmallMessenger():(this.gl_open_restart=!1,this.messengerCloseTweenDone(),this.par_audiomgr.isSoundAvailable("sfx_plinkchange")&&this.par_audiomgr.playSFXSound("sfx_plinkchange")))},this.hideIntroMessenger=function(){u.x=0,u.scaleX=1,b.visible=!1,this.hideMessenger()},this.showWindowButton=function(){switch(!pt&&T&&(window.clearInterval(T),T=null),a){case"next_lost":case"next":this.next_bt.visible=!0;break;case"nextday":this.nextday_bt.visible=!0;break;case"end_ready":g.visible=!0;break;case"restart":m.visible=!0,_.visible=!0,a="no_restart"}h.visible=!1,this.par_stage.update()},this.startEndButtonTimer=function(){T=window.setInterval(this.showWindowButton.bind(this),4e3)},this.moveBlockerToTop=function(){this.par_stage.setChildIndex(h,this.par_stage.getNumChildren()-1),this.par_stage.setChildIndex(b,this.par_stage.getNumChildren()-1)},this.triggerMessageEvent=function(e){$.event.trigger({type:e})},this.buildMessageDisplay()}function PlumPuppetScreen(e,t,i,s,n,a){var o,r=!1,l=s,d=.25,h=40,u=700,c=229,g=1.5,p=.9,m=0,_="",b=n,v=a,f=!1;this.plum_cont=new v.Container,this.plums_plink,this.plum,this.tween_msg_active=!1,this.plum_visible=!1,this.plum_speaking=!1,this.par_stage=e,this.par_audiomgr,this.buildIntroDisplay=function(e,t){this.plums_plink=new lib.plinkscreen(l+"theship2.jpg"),this.plums_plink.hideheader(),this.plum=new plumlib.PlumPuppet,this.plum.getSprites(l),this.plum.setMouth(0),this.plum.x=-.5*this.plum.nominalBounds.width,this.plum.y=-.5*this.plum.nominalBounds.height-16,this.plum.sourceRect=new createjs.Rectangle(0,0,60,42),this.plum.mask=this.plums_plink.masky,this.plums_plink.addChildAt(this.plum,1),this.plum_cont.addChild(this.plums_plink),this.plum_cont.x=e/2,this.plum_cont.y=t/2,this.par_stage.addChild(this.plum_cont),this.plum_cont.visible=!1,this.par_stage.update()},this.showPlumWelcomeScreen=function(){_="welcome",m=0,this.par_audiomgr.isSoundAvailable("sfx_plinkopen")&&this.par_audiomgr.playSFXSound("sfx_plinkopen"),this.tween_msg_active=!0,this.plum_cont.scaleX=this.plum_cont.scaleY=d,this.plum_cont.visible=!0,this.par_stage.update(),v.Tween.get(this.plum_cont).to({scaleX:g,scaleY:g},500,v.Ease.backOut).call(this.plumTweenDone.bind(this))},this.showPlumIntroScreen=function(){_="intro",this.tween_msg_active=!0,v.Tween.get(this.plum_cont).to({scaleX:p,scaleY:p,x:u,y:c},500,v.Ease.backOut).call(this.plumTweenDone.bind(this))},this.showPlumFinaleScreen=function(e){_="end",this.plum.x=550,this.plum.y=125,m=e?h:0,this.plum_cont.scaleX=this.plum_cont.scaleY=1,this.plum_cont.x=0,this.plum_cont.y=0,this.plum_cont.alpha=0,this.plum_cont.visible=!0,this.par_stage.update(),this.tween_msg_active=!0,this.par_audiomgr.isSoundAvailable("sfx_shipwhoosh")?this.par_audiomgr.playAudioSeq("sfx_shipwhoosh","on_ship",!1):$.event.trigger({type:"soundEnded",message:"on_ship"}),v.Tween.get(this.plum_cont).to({alpha:1},500).call(this.plumTweenDone.bind(this))},this.showPlumConfetti=function(){f=!0,this.plum.doConfetti()},this.hidePlumScreen=function(){"end"===_?(this.endPlumSync(),this.par_audiomgr.isSoundAvailable("sfx_shipwhoosh")&&this.par_audiomgr.playAudioSeq("sfx_shipwhoosh","",!1),f&&(f=!1,this.plum.swapTopknot(this.plum.topknotshape,this.plum.instance._antenna),this.plum.settleDown()),v.Tween.get(this.plum_cont).to({alpha:0},500).call(this.plumClosingTweenDone.bind(this))):(this.tween_msg_active=!0,v.Tween.get(this.plum_cont).to({scaleX:d,scaleY:d},500).call(this.plumClosingTweenDone.bind(this)))},this.plumTweenDone=function(){switch(this.tween_msg_active=!1,this.plum_visible=!0,this.endPlumSync(),_){case"welcome":!r&&this.par_audiomgr.isSoundAvailable("welcome_gameintro2_"+b)?this.par_audiomgr.playAudioSeq("welcome_gameintro1_"+b+",tinypause,welcome_gameintro2_"+b,"welcome_done",!0):$.event.trigger({type:"soundEnded",message:"welcome_done"}),this.plum.nofloat=!1,this.plum.floataround();
break;case"end":this.plum.nofloat=!1,this.plum.floataround(),this.triggerMessageEvent("CLEAR_ENVIRONMENT")}},this.plumClosingTweenDone=function(){this.plum.nofloat=!0,"intro"===_&&(o=new v.Bitmap(l+"theship2.jpg"),o.x=0,o.y=0,this.plum_cont.addChild(o),this.plums_plink.removeChildAt(this.plum),this.plum.mask=null,this.plum_cont.removeChild(this.plums_plink),this.plum_cont.addChild(this.plum),this.plum.scaleX=this.plum.scaleY=.8,this.plum.x=550,this.plum.y=125),this.tween_msg_active=!1,this.plum_cont.visible=!1,this.plum_visible=!1,this.par_stage.update()},this.startPlumSync=function(){this.plum_speaking=!0},this.endPlumSync=function(){this.plum_speaking=!1,this.plum.setMouth(0),this.plum.update(),this.par_stage.update()},this.updatePlum=function(){this.plum_speaking&&this.plum.setMouth(this.par_audiomgr.gamesounds.getSyncFrame()+m),this.plum.update(),this.par_stage.update()},this.makePlumHappy=function(){m=0},this.triggerMessageEvent=function(e){$.event.trigger({type:e})},this.buildIntroDisplay(t,i)}function ProgressTracker(e,t){var i=43,s=18,n=20,a=39,o=t,r=new o.Shape,l=new o.Container,d=new lib.gametext("1",".pt_num",WHT_COLOR);this.prog_block=new o.Container,this.bar_block=new o.Container,this.par_stage=e,this.day_num=1,this.buildDisplay=function(){var e=472,t=384,a=8,h=(i-s)/2+1,u=i/2,c="#473096",g="#9e89e5",p=new o.Container,m=new o.Shape,_=new o.Shape,b=new lib.gametext("DAY",".pt_hdr",g),v=new lib.gametext("12",".pt_num",g),f=new o.Shape,w=new lib.gametext("DAY",".pt_hdr",WHT_COLOR);this.prog_block.x=t,this.prog_block.y=a,m.graphics.beginFill(c).drawRoundRect(0,h,e,s,n).endFill(),this.prog_block.addChild(m),p.x=e-2*u,p.y=0,this.prog_block.addChild(p),_.graphics.beginFill(c).drawCircle(u,u,u).endFill(),p.addChild(_),b.x=u,b.y=12,b.textAlign="center",b.textBaseline="middle",p.addChild(b),v.x=u,v.y=28,v.textAlign="center",v.textBaseline="middle",p.addChild(v),this.bar_block.y=h,this.bar_block.addChild(r),this.prog_block.addChild(this.bar_block),this.prog_block.addChild(l),f.graphics.beginFill(GRN_COLOR).drawCircle(u,u,u).endFill(),l.addChild(f),w.x=u,w.y=12,w.textAlign="center",w.textBaseline="middle",l.addChild(w),d.x=u,d.y=28,d.textAlign="center",d.textBaseline="middle",l.addChild(d),this.par_stage.addChild(this.prog_block),this.updateProgressTrackerDisplay()},this.updateProgressTrackerDisplay=function(){d.text=this.day_num,l.x=a*(this.day_num-1),this.bar_block.width=l.x+i,r.graphics.clear(),r.graphics.beginFill(GRN_COLOR).drawRoundRect(0,0,this.bar_block.width,s,n).endFill(),this.par_stage.update()},this.incrementDay=function(){++this.day_num,this.updateProgressTrackerDisplay()},this.setDayNum=function(e){this.day_num=e,this.updateProgressTrackerDisplay()},this.setVWPosition=function(){this.prog_block.x=272},this.setDisplay=function(e){this.prog_block.visible=e,this.par_stage.update()},this.buildDisplay()}function ScoreBox(e,t){var i,s,n=document.getElementById(t),a=[];this.score_anim_active=!1,this.par_audiomgr,this.buildPointsBox=function(){i=document.createElement("div"),e(i).addClass("user-points-main"),e(i).addClass("pos_abs"),i.innerHTML="<h6>TOTAL: &nbsp;</h6>",s=document.createElement("h1"),s.innerHTML="0",i.appendChild(s),n.appendChild(i),e(i).css("left",144),e(i).css("top",375),e(i).hide()},this.showPointsBox=function(t){s.innerHTML=t,e(i).show()},this.hidePointsBox=function(){e(i).hide()},this.showAnimatedPointsBox=function(t){s.innerHTML=0,a=[],e(i).show(),this.countnumber(s,t)},this.countnumber=function(e,t){var i=parseInt(e.innerHTML);this.score_anim_active=!0,a.push([e,i,t]),this.par_audiomgr.isSoundAvailable("sfx_pointcount")&&this.par_audiomgr.playSFXSound("sfx_pointcount")},this.animateCounter=function(){if(a.length>0){var t=a[0],i=t[2]-t[1];if(i>0){var s=Math.max(1,parseInt(i/8));t[1]+=s>i?i:s,t[0].innerHTML=t[1]}else this.score_anim_active=!1,a.splice(0,1),this.par_audiomgr.gamesounds.stopSFX(),e.event.trigger({type:"START_REPLAY_TIMER"}),this.par_audiomgr.isSoundAvailable("tinypause")?this.par_audiomgr.playAudioSeq("tinypause","counter_done",!1):e.event.trigger({type:"soundEnded",message:"counter_done"})}},this.buildPointsBox()}var WHT_COLOR="#ffffff",PUR_COLOR="#9e89e5",DK_PUR_COLOR="#473096",COVER_COLOR="#6d44ac",ICON_COLOR=16249753,GRN_COLOR="#5ebc37",RED_COLOR="#d7353a",GRAY_COLOR="#adadad",CYAN_COLOR="#2cd0d5",BDR_COLOR="#f3f3f3",MASK_COLOR="#ff0000",BTN_COLOR="#33a1a5",terrariumGame=function(e){function t(t){var i,a,o,r,l;us=t,l=window.location.href,Nt=l.substring(l.lastIndexOf("/")+1,l.lastIndexOf(".")),It=Nt.indexOf("_virtual"),-1!==It&&(Nt=Nt.substring(0,It),Ws=!0),Bt(">>> WGBH - GAME NAME:["+Nt+"] vw_env["+Ws+"]"),Zt=document.getElementById("terr-game"),ei=document.getElementById("terrarium_canv"),cs=ei.width,gs=ei.height,o=document.createElement("canvas"),o.width=cs,o.height=gs,o.id="bg_canv",e(o).addClass("fullsize"),e(Zt).append(o),r=document.createElement("canvas"),r.width=cs,r.height=gs,r.id="anim_bg_canv",e(r).addClass("fullsize"),e(Zt).prepend(r),a=document.createElement("canvas"),a.width=cs,a.height=gs,a.id="msg_canv",e(a).addClass("fullsize"),Zt.appendChild(a),i=document.createElement("canvas"),i.width=cs,i.height=gs,i.id="ui_canv",e(i).addClass("fullsize"),Zt.appendChild(i),Yi=new LoaderSplash(e,Wi,qi,cs,gs,Es),ti=new Es.Stage(ei),ni=new Es.Stage(r),ai=new Es.Stage(o),si=new Es.Stage(a),ii=new Es.Stage(i),di=new Es.Container,ni.addChild(di),oi=new Es.Container,ri=new Es.Container,ti.addChild(oi),ui=new Es.Container,ii.addChild(ui),hi=new Es.Container,si.addChild(hi),li=new Es.Container,ai.addChild(li),zs.push({type:"preload",audio:"terr_intro_lines",sync:"terr_intro_sync"}),zs.push({type:"preload",audio:us+"_intro_lines",sync:us+"_intro_sync"}),zs.push({type:"load",audio:"terr_part1_lines",sync:""}),zs.push({type:"level3",audio:"terr_part2_lines",sync:"terr_part2_sync"}),zs.push({type:"level2",audio:us+"lines",sync:""}),ki=new AudioManager(zs),"ontouchstart"in document.documentElement&&ft(),document.body.addEventListener("touchstart",ft),i.addEventListener("mouseover",vt),Es.Touch.enable(ii,!0),ii.mouseMoveOutside=!0,Ei=new ArrowNavigation(ii,Es),oi.x=ms,oi.y=_s,Ti=new GameBackgrounds(us,Wi,di,cs,gs,Es),Ti.par_stage=ni,n(),Li=new InactivityTimer,Li.par_audiomgr=ki,Oi=new PlumPuppetScreen(si,cs,gs,Wi,us,Es),Oi.par_audiomgr=ki,ki.sync_char=Oi,Bi=new PlinkMessenger(ii,cs,gs,ji,Es),Bi.par_audiomgr=ki,Mi=new CharacterInfoBox(ii,cs,gs,ji,Es),Ri=new ProgressTracker(ai,Es),Ni=new AnimatedText(ii,Zt,Es),Ii=new GameControls(si,hi,ii,Es),Di=new IntroArrows(e,Wi,qi),Pi=new ScoreBox(e,qi),Pi.par_audiomgr=ki,Yi.addLoadingOverlay(ii),e.get(Xi+us+"config.xml",s,"XML").fail(function(){console.log("ALERT: Unable to load: "+(Xi+us+"config.xml"))}),Es.Ticker.addEventListener("tick",lt),Es.Ticker.setFPS(Fi)}function i(){e(document).on("START_WELCOME",_),e(document).on("STOP_WELCOME",b),e(document).on("LAUNCH_LOGIN",plumlogin.launchLogin),e(document).on("END_INTRO",f),e(document).on("soundEnded",rt),e(document).on("SLIDE_BACKGROUND",ut),e(document).on("RESET_TIMER",Li.resetTimer),e(document).on("ACTIVATE_TIMER",Li.activateTimer),e(document).on("START_NEW_DAY",function(){st(!0)}),e(document).on("SCORE_CHANGE",function(){Ss+=Bi.current_score}),e(document).on("START_REPLAY_TIMER",function(){Bi.startEndButtonTimer()}),e(document).on("RESTART_SELECTED",bt),e(document).on("RESTART_GAME",y),e(document).on("CLEAR_ENVIRONMENT",x),e(document).on("SHOW_POINTS",function(){Pi.showPointsBox(Ss)}),e(document).on("SHOW_POINTS_ANIM",function(){Pi.showAnimatedPointsBox(Ss)})}function s(t){var i,s,n=0;i=t.getElementsByTagName("terrarium").item(0),null!==i?(e(i).find("param").each(function(){Gt=Number(e(this).attr("lower")),Ht=Gt-Number(e(this).attr("upper")),Xt=Number(e(this).attr("scale_min")),jt=Number(e(this).attr("scale_max"))-Xt,Ei.setArrowNavigation(e(this).attr("scroll")),Ei.sctween_start=e(this).attr("startpos")}),e(i).find("loc").each(function(){Xs.push({name:e(this).attr("name"),left:e(this).attr("left"),right:e(this).attr("right"),top:e(this).attr("top"),bottom:e(this).attr("bottom")})}),ws=Xs.length,e(i).find("locicons").each(function(){e(this).find("img").each(function(){Gs.push({id:e(this).attr("id"),src:e(this).attr("src")})})}),Pt=-1,e(i).find("sp").each(function(){++Pt,js.push({name:e(this).attr("name"),fullname:e(this).attr("fullname"),loc:e(this).attr("loc"),num:Number(e(this).attr("num")),orig_amt:Number(e(this).attr("num")),family:e(this).attr("family"),freq:Number(e(this).attr("freq")),starve:Number(e(this).attr("starve")),index:Number(e(this).attr("index")),partial:"true"===e(this).attr("partial"),status:"none",movement:e(this).attr("movement"),id:Pt,loaded:!1}),n=js.length-1,js[n].food=[],e(this).find("food").each(function(){js[n].food.push(new FoodSource(e(this).attr("name"),e(this).attr("amt")))}),js[n].food.sort(Tt("amt")),s="",e(this).find("shelter").each(function(){s=s+e(this).attr("type")+","}),s.length>0&&(s=s.substr(0,s.length-1)),js[n].shelter=s,js[n].regions=js[n].loc.split(","),js[n].zones=[],e(this).find("boundary").each(function(){var t={};js[n].zones.push(t),t.region=e(this).attr("loc"),t.left=void 0!==e(this).attr("left")?Number(e(this).attr("left")):-1,t.right=void 0!==e(this).attr("right")?Number(e(this).attr("right")):-1,t.top=void 0!==e(this).attr("top")?Number(e(this).attr("top")):-1,t.bottom=void 0!==e(this).attr("bottom")?Number(e(this).attr("bottom")):-1}),js[n].points=[],e(this).find("lpoint").each(function(){js[n].points.push({x:Number(e(this).attr("x")),y:Number(e(this).attr("y"))})})}),vs=js.length,e.getJSON(Xi+us+"_icons.json",function(e){e.images[0]=Xi+e.images[0],gi=new Es.SpriteSheet(e),Bi.icon_sheet=gi,gi.complete?r():gi.addEventListener("complete",r,!1)})):console.log("Unable to load page content from xml.")}function n(){var e,t,i,s,n,a,o;e=new Es.Shape,o=e.graphics,o.beginFill(WHT_COLOR).drawRect(0,459,988,15).endFill(),li.addChild(e),o=null,t=new Es.Shape,o=t.graphics,o.beginFill("#e5e5e5").drawRect(0,474,988,15).endFill(),li.addChild(t),o=null,i=new Es.Shape,o=i.graphics,o.beginFill("#cecece").drawRect(0,490,988,66).endFill(),li.addChild(i),o=null,s=new Es.Shape,o=s.graphics,o.setStrokeStyle(1).beginStroke("#999999").moveTo(0,456.5).lineTo(988,456.5).endStroke(),li.addChild(s),o=null,n=new Es.Shape,o=n.graphics,o.setStrokeStyle(1).beginStroke("#cecece").moveTo(0,457.5).lineTo(988,457.5).endStroke(),li.addChild(n),o=null,a=new Es.Shape,o=a.graphics,o.setStrokeStyle(1).beginStroke("#999999").moveTo(0,489.5).lineTo(988,489.5).endStroke(),li.addChild(a),li.addChild(new lib.topbar),ai.update()}function a(){oi.addChild(ri),"undefined"!=typeof VirtualWorldManager&&(Si=VirtualWorldManager,qs=!0,Ai=new VWOverlay(ii,cs,gs,ji,Es),Ai.par_vworldMgr=Si,Si.setDisplayStage(ii,us),e(document).bind("VW_MESSAGE",wt),e(document).bind("VW_MESSAGE_CLICKED",yt),e(document).bind("VW_MESSAGE_CLOSED",xt),e(document).bind("VW_START_NEW_DAY",St),e(document).bind("VW_START_END_GAME",D),e(document).bind("PUP_PLUS_ONE",Ct),e(document).bind("PUP_ADD_BUBBLE",At),e(document).bind("PUP_DOUBLER",kt),Ci=BubbleManager,Ci.setDisplayContainer(ri,us),Ri.setVWPosition(),Ci.setDisplayWidth(Ti.bg_bounds.width)),o(),0!==Gs.length?(It=-1,h()):m()}function o(){switch(Ei.sctween_start){case"bottom":Ei.game_position="bottom",Ei.setArrowDisplay(),oi.x=Ti.sctween_amtX,oi.y=Ti.sctween_amtY,di.x=Ti.sctween_amtX,di.y=Ti.sctween_amtY;break;case"right":Ei.game_position="right",Ei.setArrowDisplay(),oi.x=Ti.sctween_amtX,oi.y=Ti.sctween_amtY,di.x=Ti.sctween_amtX,di.y=Ti.sctween_amtY;break;case"top":case"left":}qs&&Ci.setGameView(Ei.game_position),ii.setChildIndex(Ei.cont_nav,ii.getNumChildren()-1),ii.setChildIndex(Mi.cont_box,ii.getNumChildren()-1),Bi.moveBlockerToTop(),ii.setChildIndex(Yi.load_overlay,ii.getNumChildren()-1),Ri.setDisplay(!1),Ii.header_text.visible=!1,ui.visible=!1,li.visible=!1,Ii.restart_bt.visible=!1,Ei.cont_nav.visible=!1,ii.update(),ti.update(),si.update(),ai.update(),ni.update(),i(),Yi.launchStartButton(),Ps=plumlogin.checkLogin(),Ws&&(Ps=!0),e(document).on("org_wgbh_plumlogin_loginchange",dt),Ps?(e(document).on("org_wgbh_plumlogin_gamestarted",ht),plumlogin.startGame(Nt),Ts?ki.isSoundAvailable("hit_to_start_logged_touch")&&ki.playAudioSeq(us+"_title,tinypause,hit_to_start_logged_touch","",!1):ki.isSoundAvailable("hit_to_start_logged_key")&&ki.playAudioSeq(us+"_title,tinypause,hit_to_start_logged_key","",!1)):(Yi.showLogin(),Ts?ki.isSoundAvailable("hit_to_start_unlogged_touch")&&ki.playAudioSeq(us+"_title,tinypause,hit_to_start_unlogged_touch","",!1):ki.isSoundAvailable("hit_to_start_unlogged_key")&&ki.playAudioSeq(us+"_title,tinypause,hit_to_start_unlogged_key","",!1))}function r(){var t,i,s,n,a,o,d,h,u,c,g,p,m,_,b,v,f,w,y=.75,x=37,S=522,C=70,A=22,k=21,E=463,T="";for(gi.hasEventListener("complete",r)&&gi.removeEventListener("complete",r),t=0;vs>t;++t){for(vi=js[t],o=null,o=new Es.Container,ui.addChild(o),o.x=x+C*t,o.y=S,vi.cont=o,vi.origX=o.x,vi.origY=o.y,h=null,h=new lib.pointbubble("#bac6dc"),h.scaleX=h.scaleY=y,o.addChild(h),vi.bubble=h,T=vi.name,f=new createjs.Bitmap(gi._images[0]),f.sourceRect=gi.getFrame(gi.getAnimation(T).frames[0]).rect,f.x=-31.5,f.y=-33,f.scaleX=f.scaleY=.86,h.bubblecontains(f),h.type="regular",d=null,d=new Es.Shape,d.graphics.beginFill("#ff0000").drawRect(-30,-26,64,56).endFill(),d.alpha=.01,d.name=t,o.addChild(d),w=null,w=new lib.LifeStatus(GRN_COLOR,RED_COLOR,GRAY_COLOR),w.x=k+C*t,w.y=E,w.displayLite("none"),w.name=t,ui.addChild(w),vi.ldisp=w,o.cursor="pointer",o.addEventListener("mousedown",pt,!1),w.cursor="pointer",w.addEventListener("click",gt,!1),u=null,u=new Es.Container,a=vi.food.length,b=0,v=0,i=0;a>i;++i)++b,c=null,c=l(vi.food[i].name),u.addChild(c),b>es&&(b=1,++v),c.x=(b-1)*ts+A,c.y=v*ts;if(vi.foodicons=u,""!==vi.shelter){for(g=null,g=new Es.Container,m=[],m=vi.shelter.split(","),_=m.length,s=0;_>s;++s)for(b=-1,n=0;vs>n;++n)js[n].family===m[s]&&(++b,p=null,p=l(js[n].name),g.addChild(p),p.x=b*ts+A);vi.sheltericons=g}}ci=new Es.Shape,ci.graphics.beginFill(COVER_COLOR).drawRect(0,456,cs,gs-456).endFill(),ci.alpha=.5,ui.addChild(ci),ci.visible=!1,_i=new Es.Container,h=new lib.pointbubble(WHT_COLOR,.25),h.scaleX=h.scaleY=y,_i.addChild(h),bi=new createjs.Bitmap(gi._images[0]),bi.sourceRect=gi.getFrame(gi.getAnimation(js[0].name).frames[0]).rect,bi.x=-30,bi.y=-30,bi.scaleX=bi.scaleY=.8,h.bubblecontains(bi),_i.visible=!1,ui.addChild(_i),ii.update(),Rs=!0,e.getJSON(Xi+us+"_icons_gray.json",function(e){e.images[0]=Xi+e.images[0],pi=new Es.SpriteSheet(e)})}function l(e){var t=new Es.Container,i=new lib.fuzzycircle(Zi,2,ICON_COLOR);t.addChild(i);var s=new createjs.Bitmap(gi._images[0]);return s.sourceRect=gi.getFrame(gi.getAnimation(e).frames[0]).rect,s.x=s.y=-Zi,s.scaleX=s.scaleY=is,t.addChild(s),t}function d(e){var t=new Es.Bitmap(e.target);Gs[It].img=t,Mt=Gs[It].img.getBounds(),Gs[It].img.y=-(Mt.height/2),Gs[It].img.x=Mt.width<100?24:-12,h()}function h(){if(++It,It<Gs.length){var e;e=new Image,e.src=Xi+Gs[It].src,e.name=Gs[It].id,e.onload=d}else xs=Gs.length,m()}function u(){js[Pt].loaded=!0,++Pt,c()}function c(){var t;vs>Pt?void 0!==js[Pt].movement?e.getJSON(Xi+"animations/"+js[Pt].name+".json",function(e){for(t=0;t<e.images.length;++t)e.images[t]=Xi+"animations/"+e.images[t];js[Pt].sheet=new createjs.SpriteSheet(e),js[Pt].sheet.complete?u():js[Pt].sheet.addEventListener("complete",u)}):(js[Pt].loaded=!0,++Pt,c()):Fs=!0}function g(){xi.hasEventListener("complete",g)&&xi.removeEventListener("complete",g),Ys=!0,Pt=0,c()}function p(){var t,i;for(mi.hasEventListener("complete",p)&&mi.removeEventListener("complete",p),t=0;vs>t;++t)i=null,i=new createjs.Bitmap(mi._images[0]),i.sourceRect=mi.getFrame(mi.getAnimation(js[t].name).frames[0]).rect,js[t].largeimg=i;e.getJSON(Xi+us+"multi.json",function(e){e.images[0]=Xi+e.images[0],xi=new createjs.SpriteSheet(e),xi.complete?g():xi.addEventListener("complete",g)})}function m(){e.getJSON(Xi+us+"_large_icons.json",function(e){e.images[0]=Xi+e.images[0],mi=new createjs.SpriteSheet(e),mi.complete?p():mi.addEventListener("complete",p)})}function _(){e(document).off("START_WELCOME",_),at(),Oi.showPlumWelcomeScreen(),Bi.showWelcomeNextButton()}function b(){e(document).off("STOP_WELCOME",_),at(),Oi.endPlumSync(),v()}function v(){Bi.showIntroduction(),Oi.showPlumIntroScreen(),Ri.setDisplay(!0),Ii.header_text.visible=!0,Ei.cont_nav.visible=!0,ui.visible=!0,li.visible=!0,ii.update(),ti.update(),si.update(),ai.update()}function f(){at(),ki.remove_sounds&&ki.removeIntroSounds(),Ni.hideAnimatedText(),Di.clearIntroArrows(),Is=!0,e(document).off("LAUNCH_LOGIN",plumlogin.launchLogin),e(document).off("END_INTRO",f),Bi.hideIntroMessenger(),Oi.hidePlumScreen()}function w(){Bi.gl_open_intro=!1,Ii.restart_bt.visible=!0,qs&&Si.showPowerupArea(),ii.update(),Li.activateTimer(),Ds||ki.isSoundAvailable("welcome_days")&&ki.playAudioSeq("tinypause,welcome_days","",!1)}function y(){Ps&&plumlogin.startGame(Nt),Ti.bmp_bgday.alpha<1&&Ti.switchToDayView(),Ii.restart_bt.visible=!0,Ei.cont_nav.visible=!0,ui.visible=!0,qs&&(Si.restartGame(),ks=0),Ss=0,bs=0,Ri.setDayNum(1),As=rs,Ii.header_text.text="Add "+As+" bubbles",si.update(),x(),it(),ki.isSoundAvailable("welcome_days")?ki.playAudioSeq("pause,welcome_days","start_timer",!1):e.event.trigger({type:"soundEnded",message:"start_timer"})}function x(){var e;for(Hs=[],Dt=Vs.length-1;Dt>=0;--Dt)ri.removeChild(Vs[0].anim),Vs[0].anim=null,Vs.splice(0,1);for(fs=0,qs&&Ci.clearBubbles(),ti.update(),e=0;e<js.length;++e){if(vi=js[e],vi.num=vi.orig_amt,"grayed"===vi.bubble.type){var t=new createjs.Bitmap(gi._images[0]);t.sourceRect=gi.getFrame(gi.getAnimation(vi.name).frames[0]).rect,t.x=-31.5,t.y=-33,t.scaleX=t.scaleY=.86,vi.bubble.bubblecontains(t),vi.bubble.type="regular",vi.cont.cursor="pointer",vi.cont.addEventListener("mousedown",pt)}"none"!==vi.status&&(vi.ldisp.displayLite("none"),vi.status="none")}ii.update()}function S(){vi.num>0&&(""===vi.shelter||E(vi.shelter)?k(vi.food)?vi.loaded?C():(Yi.showLoaderAnimation(),Bs=!0):Bi.showNeedsDialog(!1,"food",vi):Bi.showNeedsDialog(!1,"shelter",vi))}function C(){var t;if(t=new PlacedCharacter(vi.name,vi.family,vi.index,vi.partial,vi.freq,vi.starve,vi.movement,Ft,vi.id,vi.shelter),Vs.push(t),fs=Vs.length,--vi.num,0===vi.num){var i=new createjs.Bitmap(pi._images[0]);i.sourceRect=pi.getFrame(pi.getAnimation(vi.name).frames[0]).rect,i.x=-31.5,i.y=-33,i.scaleX=i.scaleY=.86,vi.bubble.bubblecontains(i),vi.bubble.type="grayed",vi.cont.cursor="default",vi.cont.removeEventListener("mousedown",pt)}"none"===vi.status&&(vi.ldisp.displayLite("well"),vi.status="well"),A(qt,Wt,js[vi.id].zones,vi.family,t.region,t.movement),t.region=R(t.anim.x,t.anim.y),void 0!==vi.movement&&G(t),Ns||(Ns=!0),++bs,As-1>bs?(Ii.header_text.text="Add "+String(As-bs)+" bubbles",ki.isSoundAvailable("sfx_ding")?ki.playAudioSeq("sfx_ding","start_timer"):e.event.trigger({type:"soundEnded",message:"start_timer"})):bs===As-1?(Ii.header_text.text=qs?"Add 1 more":"Add 1 more bubble",ki.isSoundAvailable("sfx_ding")?ki.playAudioSeq("sfx_ding,oneturnleft","start_timer",!1):e.event.trigger({type:"soundEnded",message:"start_timer"})):bs===As&&(Ii.header_text.text="",tt(!0),Ti.switchToNightView(),qs&&Si.makeButtonsInactive(),Ri.day_num===os?ki.isSoundAvailable("sfx_complete")?ki.playAudioSeq("sfx_complete","show_report",!1):e.event.trigger({type:"soundEnded",message:"show_report"}):ki.isSoundAvailable("sfx_ding")?ki.playAudioSeq("sfx_ding","start_results",!1):e.event.trigger({type:"soundEnded",message:"start_results"})),si.update()}function A(e,t,i,s,n,a){var o,r,l,d;i.length>0&&(l=O(i,n),void 0!==l&&(-1!==l.left&&e<l.left&&(e=l.left),-1!==l.right&&e>l.right&&(e=l.right),-1!==l.top&&t<l.top&&(t=l.top),-1!==l.bottom&&t>l.bottom&&(t=l.bottom))),"reptile"===s&&"fly"===a&&(d=K(e,t),e=d.x,t=d.y),Vt=1-Math.min(Gt-t,Ht)/Ht,$t=Xt+Vt*jt,void 0!==vi.movement?(r=new xlib.MovingCritter(vi.name,vi.sheet),r.scaleX=r.scaleY=$t,r.setpos(Number(e),Number(t))):(o=new plumlib.Critter(vi.name,xi),r=new Es.Container,r.addChild(o),r.scaleX=r.scaleY=$t,r.x=e,r.y=t),ri.addChild(r),Vs[Vs.length-1].anim=r,"tree"===vi.family&&(Hs.push({anim:r,x:r.x,y:r.y,scale:$t,nested:[],points:vi.points,flipped:o.flipped}),ys=Hs.length),ti.update()}function k(e){var t,i,s,n=!1,a=e.length;for(n=0===e.length,t=0;a>t;++t){for(s=e[t].name,i=0;fs>i;++i)if(s===Vs[i].name){n=!0;break}if(n)break}return n}function E(e){var t,i,s=e.split(","),n=s.length,a=!1;for(t=0;n>t;++t)for(i=0;fs>i;++i)s[t]===Vs[i].family&&(a=!0);return s=null,a}function T(e,t){var i,s=e.length,n=!1;for(i=0;s>i;++i)if(e[i]===t){n=!0;break}return n}function L(e){var t,i={};for(t=0;ws>t;++t)if(e===Xs[t].name){i.left=Xs[t].left,i.right=Xs[t].right,i.top=Xs[t].top,i.bottom=Xs[t].bottom;break}return i}function R(e,t){var i,s="";for(i=0;i<Xs.length;++i)e>=Xs[i].left&&e<=Xs[i].right&&t>=Xs[i].top&&t<=Xs[i].bottom&&(s=Xs[i].name);return s}function O(e,t){var i,s,n=e.length;for(i=0;n>i;++i)t===e[i].region&&(s=e[i]);return s}function B(e,t){return-1!==t.left&&e.left<t.left&&(e.left=t.left),-1!==t.right&&e.right>t.right&&(e.right=t.right),-1!==t.top&&e.top<t.top&&(e.top=t.top),-1!==t.bottom&&e.bottom>t.bottom&&(e.bottom=t.bottom),e}function N(e){var t,i;for(t=0;xs>t;++t)if(e==Gs[t].id){i=Gs[t].img;break}return i}function M(e){var t,i;for(t=0;fs>t;++t)if(e===Vs[t].anim){i=Vs[t];break}return i}function I(){var e,t,i;for(bs=0,Vs.sort(Tt("index")),e=0;fs>e;++e)t=Vs[e],0!==t.freq&&(t.last_ate>=t.freq&&(i=P(t.name),t.starving=!i,i&&(t.last_ate=0)),++t.last_ate);F(),et(),qs&&("water"===us?Bi.species_well.length>=ds&&Si.greenLightBonusAchieved():Bi.species_well.length>=ls&&Si.greenLightBonusAchieved(),Bi.species_lost.length>0?ks=0:(++ks,ks===hs&&(Si.noSpeciesLostBonusAchieved(),ks=0))),Ri.day_num===os?(qs&&Si.isDoublePoints()?(Ss+=Bi.species_well.length*ns*2,Ss+=Bi.species_hungry.length*ss*2):(Ss+=Bi.species_well.length*ns,Ss+=Bi.species_hungry.length*ss),Bi.species_well.length+Bi.species_hungry.length===vs&&(Ss+=as),Ps&&(plumlogin.savePoints(Nt,Ss),Ss>Cs&&(Cs=Ss,qs&&Si.newHighScoreBonusAchieved())),qs?(tt(),Si.readyEndOfGame()):D()):1===Ri.day_num?Bi.showDailyReport(!1,qs&&Si.isDoublePoints()):Bi.showDailyReport(!1,qs&&Si.isDoublePoints())}function D(){var e;for(it(),e=0;e<game_results.length;++e)if(Ss>=game_results[e].lo&&Ss<=game_results[e].hi){Qt=e,Oi.showPlumFinaleScreen(game_results[Qt].sad),ui.visible=!1,Ii.restart_bt.visible=!1,Ei.cont_nav.visible=!1,qs&&Si.hidePowerupArea(),ii.update();break}}function P(e){var t,i,s,n,a,o=!1,r=Et("name",e,"food"),l=r.length,d=100,h=0,u=0;for(t=0;l>t;++t)if(u=r[t].amt*(d/100),s=Y(r[t].name),n=s.length,n>0){for(i=0;n>i;++i)if(a=s[i].life,a>0){if(a>=u){Vs[s[i].index].life=s[i].partial?Lt(Vs[s[i].index].life-u):0,u=0;break}u-=s[i].life,Vs[s[i].index].life=0}if(0>=u){h=100;break}h=100-100*Lt(u/r[t].amt),d-=h}return h>=100&&(o=!0),o}function Y(e){var t,i=[];for(t=0;fs>t;++t)Vs[t].name===e&&i.push({index:t,life:Vs[t].life,partial:Vs[t].partial});return i}function F(){var e,t,i,s,n,a,o=fs-1;for(Bi.species_lost=[],o;o>=0;--o)if(n=0===Vs[o].freq?0:Vs[o].starve-Vs[o].last_ate,Vs[o].life<=0||0>n){if(a=Vs[o].name,"tree"===Vs[o].family){if(1===ys){for(t=0;t<Hs[0].nested.length;++t)i=Hs[0].nested[t],s=O(js[M(i).id].zones,"ground"),i.currY=i.y,i.targY=Rt(s.top,s.bottom),i.currSc=i.scaleY,Vt=1-(s.bottom-i.targY)/Ht,$t=Xt+Vt*jt,i.targSc=$t,M(Hs[0].nested[t]).resting=!1,Hs[0].nested[t].headToPoint(Rt(s.left,s.right),i.targY);Hs=[]}else for(e=0;ys>e;++e)if(Hs[e].anim===Vs[o].anim){for(t=Hs[e].nested.length-1;t>=0;--t)void 0!==Hs[e].nested[t]&&(M(Hs[e].nested[t]).resting=!1,"reptile"!==M(Hs[e].nested[t]).family?$(Hs[e].nested[t]):U(Hs[e].nested[t],e,!0));Hs.splice(e,1);break}ys=Hs.length}if("tree"===Vs[o].shelter)for(e=0;ys>e;++e)for(t=0;t<Hs[e].nested.length;++t)if(Hs[e].nested[t]===Vs[o].anim){Hs[e].nested.splice(t,1);break}ri.removeChild(Vs[o].anim),Vs[o].anim=null,Vs.splice(o,1),fs=Vs.length,q(a)||Bi.species_lost.push(a)}ti.update()}function q(e){var t,i=!1;for(t=0;fs>t;++t)if(e===Vs[t].name){i=!0;break}return i}function W(){var e,t;for($s=[],e=0;fs>e;++e)$s.push({name:Vs[e].name,"char":Vs[e].anim,charY:Vs[e].anim.y,scaleY:Vs[e].anim.scaleY});for($s.sort(Tt("charY")),qs&&Ci.getNumBubblesPlaced&&Ci.addBubblesToArray($s),$s.sort(Tt("scaleY")),t=$s.length,e=t-1;e>=0;--e)ri.setChildIndex($s[e]["char"],0);$s=[],ti.update()}function X(){var e;for(e=0;fs>e;++e)fi=null,fi=Vs[e],void 0!==fi.movement&&(wi=fi.anim,fi.resting?(--fi.delay_counter,0===fi.delay_counter&&(fi.resting=!1,G(fi))):wi.atdestination()?(fi.region=R(fi.anim.x,fi.anim.y),"fly"===fi.movement&&"insect"===fi.family||"swim"===fi.movement?G(fi):H(fi)):("fly"===fi.movement&&(zt=wi.currY-wi.targY,Kt=(wi.currY-wi.y)/zt,Ut=wi.currSc-wi.targSc,Jt=wi.currSc-Kt*Ut,wi.scaleX=wi.scaleY=Jt),wi.update()))}function G(e){switch(e.movement){case"walk":case"swim":j(e);break;case"fly":"tree"===e.shelter?"bird"===e.family?$(e.anim):z(e.anim):V(e)}}function H(e){e.delay_counter=Rt(Ui,Ki),e.resting=!0}function j(e){var t,i=L(e.region),s=O(js[e.id].zones,e.region);void 0!==s&&(i=B(i,s)),t=Rt(i.left,i.right),e.anim.headToPoint(t,e.anim.yloc)}function V(e){var t=e.anim;reg_flbounds=L(e.region),spec_flbounds=O(js[e.id].zones,e.region),void 0!==spec_flbounds&&(reg_flbounds=B(reg_flbounds,spec_flbounds)),t.currY=t.y,t.targY=Rt(reg_flbounds.top,reg_flbounds.bottom),t.currSc=t.scaleY,Vt=1-Math.min(Gt-t.targY,Ht)/Ht,$t=Xt+Vt*jt,t.targSc=$t,t.headToPoint(Rt(reg_flbounds.left,reg_flbounds.right),t.targY)}function $(e){var t,i,s,n,a=-1,o=!1;if(0===ys)H(M(e));else if(1===ys){for(o=!1,i=0;i<Hs[0].nested.length;++i)if(e===Hs[0].nested[i]){o=!0;break}o?H(M(e)):(Hs[0].nested.push(e),s=Z(Hs[0]),e.currY=e.y,e.targY=s.y,e.currSc=e.scaleY,e.targSc=Hs[0].anim.scaleY+.01,e.headToPoint(s.x,s.y))}else{for(o=!1,t=0;ys>t;++t){for(i=0;i<Hs[t].nested.length;++i)if(e===Hs[t].nested[i]){o=!0;break}if(o){a=t;break}}for(n=a;n===a;)n=Rt(0,ys-1);if(Hs[n].nested.push(e),s=Z(Hs[n]),e.currY=e.y,e.targY=s.y,e.currSc=e.scaleY,e.targSc=Hs[n].anim.scaleY+.01,e.headToPoint(s.x,s.y),-1!==a)for(i=0;i<Hs[a].nested.length;++i)if(e===Hs[a].nested[i]){Hs[a].nested.splice(i,1);break}}}function z(e){var t,i,s=-1,n=!1;if(!Q(e))if(1===ys){for(n=!1,i=0;i<Hs[0].nested.length;++i)if(e===Hs[0].nested[i]){n=!0;break}n||U(e,-1,!0)}else{for(s=-1,t=0;ys>t;++t)for(i=0;i<Hs[t].nested.length;++i)if(e===Hs[t].nested[i]){s=t;break}U(e,s,!1)}}function U(e,t,i){var s,n;n=J(e,t),-1!==n.x?(e.currY=e.y,e.targY=n.y,e.currSc=e.scaleY,e.targSc=Hs[0].anim.scaleY+.01,e.headToPoint(n.x,n.y)):i&&(s=O(js[M(e).id].zones,"ground"),e.currY=e.y,e.targY=Rt(s.top,s.bottom),e.currSc=e.scaleY,Vt=1-(s.bottom-e.targY)/Ht,$t=Xt+Vt*jt,e.targSc=$t,e.headToPoint(Rt(s.left,s.right),e.targY))}function K(e,t){var i,s,n,a,o=-1,r=[],l={};for(a=!1,l.x=e,l.y=t,i=0;ys>i;++i)for(n=Hs[i].points.length,s=0;n>s;++s){if(yi=Hs[i],o=yi.y+yi.points[s].y*yi.scale-t,o>0){a=!0;break}r.push(yi.y+yi.points[s].y*yi.scale)}return a||(r.sort(function(e,t){return t-e}),l.y=r[0]-60),l}function J(e,t){var i,s,n,a,o,r,l=[],d=-1,h=-1,u=e.y;for(gl_vect={},gl_vect.x=gl_vect.y=-1,i=0;ys>i;++i)if(i!==t)for(o=Hs[i].points.length,s=0;o>s;++s)yi=Hs[i],d=yi.y+yi.points[s].y*yi.scale-u,d>0&&l.push({tnum:i,pnum:s});return l.length>0&&(r=Rt(0,l.length-1),yi=Hs[l[r].tnum],h=l[r].pnum,l=[],yi.nested.push(e),n=Rt(yi.points[h].x-$i,yi.points[h].x+$i),a=Rt(yi.points[h].y-$i,yi.points[h].y),n*=yi.scale,yi.flipped&&(n=-n),gl_vect.y=yi.y+a*yi.scale,gl_vect.x=yi.x+n),gl_vect}function Q(e){var t=!1,i=O(js[M(e).id].zones,"ground");return e.x>=i.left&&e.x<=i.right&&e.y>=i.top&&e.y<=i.bottom&&(t=!0),t}function Z(e){var t,i,s,n,a={};return yi=e,t=Rt(0,yi.points.length-1),s=Rt(yi.points[t].x-$i,yi.points[t].x+$i),n=Rt(yi.points[t].y-$i,yi.points[t].y),a.y=yi.y+n*yi.scale,i=s*yi.scale,yi.flipped&&(i=-i),a.x=yi.x+i,a}function et(){var e,t,i,s,n;for(Bi.species_well=[],Bi.species_hungry=[],e=0;vs>e;++e){for(i=js[e].name,s=!1,n=!1,t=0;fs>t;++t)i===Vs[t].name&&(s=!0,Vs[t].starving&&(n=!0));s?n?(Bi.species_hungry.push(i),js[e].ldisp.displayLite("hungry"),js[e].status="hungry"):(Bi.species_well.push(i),js[e].ldisp.displayLite("well"),js[e].status="well"):(js[e].ldisp.displayLite("none"),js[e].status="none"),ii.update()}}function tt(e){Bi.blockInteractions(),e&&(ci.visible=!0,Ei.arrow_cover.visible=!0,ii.update())}function it(){ci.visible&&(ci.visible=!1,Ei.arrow_cover.visible=!1,ii.update())}function st(t){if(t&&qs)return tt(),void Si.readyForNewDay();var i;it(),Bi.unblockInteractions(),Ti.switchToDayView(),Ri.incrementDay(),As=rs,Ii.header_text.text="Add "+String(As)+" bubbles",si.update(),qs&&Si.resetPowerUps(),Ri.day_num===os?ki.isSoundAvailable("onedayleft")?ki.playAudioSeq("onedayleft","start_timer",!1):e.event.trigger({type:"soundEnded",message:"start_timer"}):1===Ri.day_num?ki.isSoundAvailable("welcome_days")?ki.playAudioSeq("welcome_days","start_timer",!1):e.event.trigger({type:"soundEnded",message:"start_timer"}):(i=getRandomPhrase(Us),ki.isSoundAvailable(i)?ki.playAudioSeq(i,"start_timer",!1):e.event.trigger({type:"soundEnded",message:"start_timer"}))}function nt(){Bi.gl_open_intro&&(at(),f()),Bi.gl_open_report&&(at(),Bi.closeOpenMessages()),Bi.gl_open_restart&&(at(),Bi.closeOpenMessages()),Mi.gl_open_char&&(at(),Mi.hideBox()),qs&&Ai.vw_open_msg&&(Si.msgBackgroundClicked(),Ai.hideVWOverlay())}function at(){Oi.plum_visible&&Oi.endPlumSync(),ki.stopAllSounds()}function ot(){var e=0;return ki.sounds_loaded&&++e,Ti.backgrounds_loaded&&++e,Rs&&++e,Yi.updateLoadbar(e/Hi),e===Hi}function rt(t){switch(t.message){case"start_timer":Li.activateTimer();break;case"speak_needsfood":ki.isSoundAvailable("nofood")?ki.playAudioSeq("nofood","show_button",!1):e.event.trigger({type:"soundEnded",message:"show_button"});break;case"speak_needshome":ki.isSoundAvailable("needshome")?ki.playAudioSeq("needshome","show_button",!1):e.event.trigger({type:"soundEnded",message:"show_button"});break;case"speak_needsregion":ki.isSoundAvailable("cantlivehere")?ki.playAudioSeq("cantlivehere","show_button",!1):e.event.trigger({type:"soundEnded",message:"show_button"});break;case"start_results":ki.isSoundAvailable("ecosystem_report")?ki.playAudioSeq("ecosystem_report","show_report",!1):e.event.trigger({type:"soundEnded",message:"show_report"});break;case"show_report":I();break;case"speak_startover":ki.isSoundAvailable("startover")?ki.playAudioSeq("startover","show_button",!1):e.event.trigger({type:"soundEnded",message:"show_button"});break;case"show_button":Bi.showWindowButton();break;case"on_ship":Bi.startGameEndDisplay();break;case"counter_done":Bi.showEndTitle(game_results[Qt].txt),game_results[Qt].conf?(Oi.showPlumConfetti(),ki.isSoundAvailable("sfx_celebration")?ki.playAudioSeq("sfx_celebration","plum_ending",!1):e.event.trigger({type:"soundEnded",message:"plum_ending"})):ki.isSoundAvailable("endgame_congrats"+game_results[Qt].vo)?ki.playAudioSeq("endgame_congrats"+game_results[Qt].vo+",pause","show_plagain",!0):e.event.trigger({type:"soundEnded",message:"show_plagain"});break;case"plum_ending":ki.isSoundAvailable("endgame_congrats"+game_results[Qt].vo)?ki.playAudioSeq("endgame_congrats"+game_results[Qt].vo+",pause","show_plagain",!0):e.event.trigger({type:"soundEnded",message:"show_plagain"});break;case"play_again":Pi.hidePointsBox(),Bi.hideMessenger(),Oi.hidePlumScreen();break;case"show_plagain":Bi.showWindowButton(),Oi.makePlumHappy(),ki.isSoundAvailable("endgame_playagain")&&ki.playAudioSeq("endgame_playagain","",!0);break;case"remove_sounds":ki.remove_sounds&&ki.removeIntroSounds();break;case"intro_done":ki.isSoundAvailable("welcome_gameintro_start")?ki.playAudioSeq("welcome_gameintro_start","remove_sounds",!0):e.event.trigger({type:"soundEnded",message:"remove_sounds"}),Bi.showIntroOkayBT(),Di.clearIntroArrows(),Ni.nextIntroAnimatedText(Ts,!0);break;case"speak_arrows":Ni.nextIntroAnimatedText(Ts,!0),ki.isSoundAvailable("welcome_gameintro_arrows")?ki.playAudioSeq("welcome_gameintro_arrows,pause","intro_done",!0):e.event.trigger({type:"soundEnded",message:"intro_done"}),Di.showIntroArrow();break;
case"speak_lights":Ni.nextIntroAnimatedText(Ts,!0),Ts?ki.isSoundAvailable("welcome_gameintro_lights_touch")?ki.playAudioSeq("welcome_gameintro_lights_touch,pause","speak_arrows",!0):e.event.trigger({type:"soundEnded",message:"speak_arrows"}):ki.isSoundAvailable("welcome_gameintro_lights_key")?ki.playAudioSeq("welcome_gameintro_lights_key,pause","speak_arrows",!0):e.event.trigger({type:"soundEnded",message:"speak_arrows"}),Di.showIntroArrow();break;case"speak_bubbles":Ni.nextIntroAnimatedText(Ts,!0),ki.isSoundAvailable("welcome_gameintro_bubbles")?ki.playAudioSeq("welcome_gameintro_bubbles,pause","speak_lights",!0):e.event.trigger({type:"soundEnded",message:"speak_lights"}),Di.showIntroArrow();break;case"speak_mission":Ni.nextIntroAnimatedText(Ts,!0),ki.isSoundAvailable("welcome_gameintro_days")?ki.playAudioSeq("welcome_gameintro_days,tinypause","speak_bubbles",!0):e.event.trigger({type:"soundEnded",message:"speak_bubbles"});break;case"welcome_done":Oi.endPlumSync(),v()}}function lt(){Ls&&ot()&&(Ls=!1,a()),Os&&(ti.update(),ni.update()),Ti.tween_bg&&ni.update(),Bi.tween_ui_active&&ii.update(),Oi.tween_msg_active&&si.update(),Bs&&vi.loaded&&(Bs=!1,Yi.hideLoaderAnimation(),C()),Ns&&(qs&&Ci.updateBubbles(),W(),X(),ti.update()),Li.active_timer&&Li.updateTimer(),Oi.plum_visible&&Oi.updatePlum(),Ni.text_anim_active&&Ni.animateText(),Pi.score_anim_active&&Pi.animateCounter(),!Is||Oi.plum_visible||Bi.intro_active||(Is=!1,w())}function dt(t){Ps=t.payload.u,Yi.isSplashVisible()&&(Ps?Yi.hideLogin():Yi.showLogin()),Ps?(e(document).on("org_wgbh_plumlogin_gamestarted",ht),plumlogin.startGame(Nt)):Cs=0,Si.loginStatusChange(Ps)}function ht(t){e(document).off("org_wgbh_plumlogin_gamestarted",ht),Cs=t.payload.gamestatus.highscore,Bt(">>>> WGBH - PLAYERS HIGH SCORE: "+Cs)}function ut(){if(!Os)switch(nt(),Os=!0,qs&&Ci.setGameView(Ei.game_position),Ei.game_position){case"right":case"bottom":Es.Tween.get(oi).to({x:Ti.sctween_amtX,y:Ti.sctween_amtY},Vi,Es.Ease.quintOut),Es.Tween.get(di).to({x:Ti.sctween_amtX,y:Ti.sctween_amtY},Vi,Es.Ease.quintOut).call(ct);break;case"left":case"top":Es.Tween.get(oi).to({x:0,y:0},Vi,Es.Ease.quintOut),Es.Tween.get(di).to({x:0,y:0},Vi,Es.Ease.quintOut).call(ct)}}function ct(){Ei.setArrowDisplay(),Os=!1}function gt(e){nt(),Bi.intro_active&&(Ds=!0),Li.resetTimer(),vi=null,vi=js[Number(e.target.parent.name)],0===vi.num?ki.isSoundAvailable(vi.name)&&ki.playAudioSeq(vi.name+",tinypause,theseallgone","",!1):ki.isSoundAvailable(vi.name)&&ki.playAudioSeq(vi.name,"",!1),Mi.showBox(vi),ii.update()}function pt(e){Li.deactivateTimer(),nt(),vi=null,vi=js[Number(e.target.name)],bi.sourceRect=gi.getFrame(gi.getAnimation(js[Number(e.target.name)].name).frames[0]).rect,_i.visible=!0,_i.x=qt=e.stageX,_i.y=Wt=e.stageY+ps,Ms=!0,ii.update(),ii.addEventListener("stagemousemove",mt),ii.addEventListener("pressup",_t)}function mt(e){qt=e.stageX,Wt=e.stageY+ps,Ms=Wt>=zi,qt=Math.max(qt,Ji),qt=Math.min(qt,cs-Ji),Wt=Math.max(Wt,Qi),_i.x=qt,_i.y=Wt,qt-=oi.x,Wt-=oi.y,ii.update()}function _t(){ii.removeEventListener("stagemousemove",mt),ii.removeEventListener("pressup",_t),Ms?Li.activateTimer():(Yt=R(qt,Wt),T(vi.regions,Yt)?(Ft=Yt,S()):(Bi.intro_active&&(Ds=!0),Bi.showNeedsDialog(!1,"region",vi,N(vi.regions)))),check_icon=!1,_i.visible=!1,ii.update()}function bt(){tt(!1),Li.deactivateTimer(),nt(),Bi.showRestartDialog(!1)}function vt(e){Ts=!1,ps=0,e.target.removeEventListener("mouseover",vt),ii.enableMouseOver(Fi)}function ft(e){Ts=!0,ps=Gi,void 0!==e&&document.body.addEventListener("touchstart",ft)}function wt(){nt(),Ai.showVWOverlay()}function yt(){Si.msgBackgroundClicked()}function xt(){Ai.hideVWOverlay()}function St(){st(!1)}function Ct(){++As,Ii.header_text.text="Add "+String(As-bs)+" bubbles",ki.isSoundAvailable("sfx_pop")&&ki.playSFXSound("sfx_pop"),si.update()}function At(){Ci.addNewBubble(),Ns||(Ns=!0),ki.isSoundAvailable("sfx_bubblelaunch")&&ki.playSFXSound("sfx_bubblelaunch"),0===Ci.getNumBubblesAvailable()&&Si.noMoreBubbleBuddies()}function kt(){ki.isSoundAvailable("sfx_quickclick")&&ki.playSFXSound("sfx_quickclick")}function Et(e,t,i){var s,n;for(s=0;vs>s;++s)if(js[s][e]===t){n=js[s][i];break}return n}function Tt(e){return function(t,i){return t[e]-i[e]}}function Lt(e){return e=Math.round(100*e)/100}function Rt(e,t){return t=Number(t)+1,e=Number(e),Math.floor(Math.random()*(t-e))+e}function Ot(e,t){var i,s=e.length;for(i=0;s>i;++i)t.push(e[i])}function Bt(e){Ks&&console.log(e)}var Nt,Mt,It,Dt,Pt,Yt,Ft,qt,Wt,Xt,Gt,Ht,jt,Vt,$t,zt,Ut,Kt,Jt,Qt,Zt,ei,ti,ii,si,ni,ai,oi,ri,li,di,hi,ui,ci,gi,pi,mi,_i,bi,vi,fi,wi,yi,xi,Si,Ci,Ai,ki,Ei,Ti,Li,Ri,Oi,Bi,Ni,Mi,Ii,Di,Pi,Yi,Fi=30,qi="terr-game-box",Wi="i/",Xi="assets/",Gi=-50,Hi=3,ji=100,Vi=1500,$i=6,zi=457,Ui=150,Ki=360,Ji=29,Qi=90,Zi=22,es=3,ts=60,is=.55,ss=5,ns=10,as=100,os=12,rs=5,ls=8,ds=6,hs=3,us="",cs=0,gs=0,ps=0,ms=0,_s=0,bs=0,vs=0,fs=0,ws=0,ys=0,xs=0,Ss=0,Cs=0,As=rs,ks=0,Es=createjs,Ts=!1,Ls=!0,Rs=!1,Os=!1,Bs=!1,Ns=!1,Ms=!0,Is=!1,Ds=!1,Ps=!1,Ys=!1,Fs=!1,qs=!1,Ws=!1,Xs=[],Gs=[],Hs=[],js=[],Vs=[],$s=[],zs=[];game_results=[{txt:"Good effort!",conf:!1,sad:!0,lo:0,hi:300,vo:4},{txt:"Not bad!",conf:!1,sad:!1,lo:301,hi:800,vo:3},{txt:"Awesome!",conf:!0,sad:!1,lo:801,hi:1400,vo:2},{txt:"Incredible!",conf:!0,sad:!1,lo:1401,hi:2e3,vo:1}];var Us={};Us.options=["newday","newday2","newday3"],Us.select=["newday","newday2","newday3"],Us.last="";var Ks=!1;this.getRandomPhrase=function(e){var t,i="";if(1===e.select.length)i=e.select[0],e.last=i,e.select=[],Ot(e.options,e.select);else{i=e.last;for(var s=0;i===e.last;)++s,t=Rt(0,e.select.length-1),i=e.select[t];e.select.splice(t,1),e.last=i}return i},t(gameType)}(jQuery);