PBS.KIDS.storybook.audio = {
    player : {},

    narrations : {
        narration_1_default : [
            'ding'
        ],
        narration_1A : [
            '1000ms_of_silence',
            'this_pair_of_shimmering_ice_skates_will_surely'
        ],
        narration_1B : [
            '1000ms_of_silence',
            'this_fluffy_pet_squirrel_will_be_the_perfect'
        ],
        narration_1C : [
            '1000ms_of_silence',
            'this_sparkling_scepter_of_smiles_will_surely'
        ],
        narration_2_default : [
            'ding'
        ],
        narration_2A : [
            '1000ms_of_silence',
            'with_this_fantastic_glowing_gown'
        ],
        narration_2B : [
            '1000ms_of_silence',
            'with_this_terrific_jazzy_jumper'
        ],
        narration_2C : [
            '1000ms_of_silence',
            'with_this_stunning_sweet_summer_dress'
        ],
        narration_3_default : [
            'ding'
        ],
        narration_3A : [
            '1000ms_of_silence',
            'on_count_cloudys_captivating_cloud_i_will'
        ],
        narration_3B : [
            '1000ms_of_silence',
            'on_the_mystical_magic_pony_i_will_definitely'
        ],
        narration_3C : [
            '1000ms_of_silence',
            'on_the_whimsical_giant_winged_puppy_i_will'
        ]
    },

    clips : [

        // items
        {
            // A sparkling scepter of smiles
            clipId : '1C',
            startTime: 213.050000,
            endTime: 216.590000,
            loop: false
        },
        {
            // A fluffy pet squirrel
            clipId : '1B',
            startTime: 218.380000,
            endTime: 220.680000,
            loop: false
        },
        {
            // A pair of shimmering ice skates
            clipId : '1A',
            startTime: 222.470000,
            endTime: 225.780000,
            loop: false
        },
        {
            // glowing gown
            clipId : '2A',
            startTime: 295.630000,
            endTime: 297.260000,
            loop: false
        },
        {
            // A sweet summer dress
            clipId : '2C',
            startTime: 299.040000,
            endTime: 301.430000,
            loop: false
        },
        {
            // A jazzy jumper
            clipId : '2B',
            startTime: 303.210000,
            endTime: 305.460000,
            loop: false
        },
        {
            // A mystical magic pony
            clipId : '3B',
            startTime: 77.080000,
            endTime: 80.240000,
            loop: false
        },
        {
            // Count Cloudy's captivating cloud
            clipId : '3A',
            startTime:  82.030000,
            endTime: 85.350000,
            loop: false
        },
        {
            // A whimsical giant winged puppy
            clipId : '3C',
            startTime: 87.140000,
            endTime: 90.620000,
            loop: false
        },



        // main text
        {
            // Once upon a time, Pretty Princess was getting ready to attend a birthday party for her friends, the Berry Buddies.
            clipId : 'once_upon_a_time',
            startTime: 0.1,
            endTime: 8.470000,
            loop: false
        },
        {
            // Attend. To attend means to go to or be at an event. Pretty Princess was all excited to attend the Berry Buddies' birthday bash.
            clipId : 'attend_definition',
            startTime: 264.090000,
            endTime: 275.880000,
            loop: false
        },
        {
            // She wanted to take them a special gift
            clipId : 'she_wanted_to_take_them_a_special_gift',
            startTime: 155.780000,
            endTime: 158.890000,
            loop: false
        },
        {
            // With
            clipId : 'with',
            startTime: 277.650000,
            endTime: 278.500000,
            loop: false
        },
        {
            // For the Berry Buddies Pretty Princess started to get ready for the party, but had yet to decide what to wear
            clipId : 'for_the_berry_buddies_pretty_princess_started',
            startTime: 280.450000,
            endTime: 288.730000,
            loop: false
        },
        {
            // Pretty Princess searched through her closet for
            clipId : 'pretty_princess_searched_through',
            startTime: 290.500000,
            endTime: 293.840000,
            loop: false
        },
        {
            // Fully flawless in
            clipId : 'fully_flawless_in',
            startTime: 57.030000,
            endTime: 59.050000,
            loop: false
        },
        {
            // Flawless. Flawless means when something is so perfect that there is absolutely nothing wrong with it. Pretty Princess looked flawless in her party outfit.
            clipId : 'flawless_definition',
            startTime: 141.790000,
            endTime: 154.000000,
            loop: false
        },
        {
            // And with the perfect gift for the Berry Buddies
            clipId : 'and_with_the_perfect_gift_for',
            startTime: 60.840000,
            endTime: 64.220000,
            loop: false
        },
        {
            // Pretty Princess suddenly realized she was going to be late
            clipId : 'pretty_princess_suddenly_realized_she_was_going_to',
            startTime: 66.010000,
            endTime: 70.330000,
            loop: false
        },
        {
            // Pretty Princess looking fashionable arrived at the Berry Buddies' party on time riding
            clipId : 'pretty_princess_looking_fashionable_arrived',
            startTime: 174.210000,
            endTime: 182.690000,
            loop: false
        },
        {
            // dressed in
            clipId : 'dressed_in',
            startTime: 184.480000,
            endTime: 185.820000,
            loop: false
        },
        {
            // She gave them her gift
            clipId : 'she_gave_them_their_gift',
            startTime: 187.610000,
            endTime: 189.580000,
            loop: false
        },
        {
            // Which they cherished
            clipId : 'which_they_cherished',
            startTime: 191.360000,
            endTime: 193.330000,
            loop: false
        },
        {
            // Cherished. To cherish something means to care deeply about it and treat it in a loving way. The Berry Buddies cherished their gift from Pretty Princess
            clipId : 'cherished_definition',
            startTime: 199.600000,
            endTime: 211.270000,
            loop: false
        },
        {
            // And they all lived happily ever after.
            clipId : 'and_they_all_lived_happily_ever_after',
            startTime: 195.110000,
            endTime: 197.810000,
            loop: false
        },
        {
            // Now she must rush to the party aboard
            clipId : 'now_she_must_rush_to_the_party',
            startTime: 72.100000,
            endTime: 75.290000,
            loop: false
        },
        // secondary text
        {
            // Pretty Princess mused
            clipId : 'pretty_princess_mused',
            startTime: 307.250000,
            endTime: 309.440000,
            loop: false
        },
        {
            // What shall I wear to the party?
            clipId : 'what_shall_i_wear_to_the_party',
            startTime: 10.260000,
            endTime: 12.750000,
            loop: false
        },
        {
            // Pretty Princess sighed and said
            clipId : 'pretty_princess_sighed_and_said',
            startTime: 227.550000,
            endTime: 230.630000,
            loop: false
        },
        {
            // Which gift should I take for the Berry Buddies?
            clipId : 'which_gift_should_i_take_for',
            startTime: 232.400000,
            endTime: 235.360000,
            loop: false
        },
        {
            // This sparkling scepter of smiles will surely make the Berry Buddies beam with delight.
            clipId : 'this_sparkling_scepter_of_smiles_will_surely',
            startTime: 242.050000,
            endTime: 247.970000,
            loop: false
        },
        {
             // This fluffy pet squirrel will be the perfect pet for the Berry Buddies.
             clipId : 'this_fluffy_pet_squirrel_will_be_the_perfect',
             startTime: 249.730000,
             endTime: 254.860000,
             loop: false
        },
        {
             // This pair of shimmering ice skates will surely warm the Berry Buddies' hearts.
             clipId : 'this_pair_of_shimmering_ice_skates_will_surely',
             startTime: 256.640000,
             endTime: 262.300000,
             loop: false
        },

        {
            // Pretty Princess worriedly gasped
            clipId : 'pretty_princess_worriedly_gasped',
            startTime: 92.410000,
            endTime: 95.430000,
            loop: false
        },
        {
            // Gasped. To gasp means to breathe suddenly in shock or surprise. Pretty Princess gasped when she realized she was running late to the party.
            clipId : 'gasped_definition',
            startTime: 160.680000,
            endTime: 172.420000,
            loop: false
        },
        {
            // Pretty Princess gasped with joy
            clipId : 'pretty_princess_gasped_with_joy',
            startTime: 14.540000,
            endTime: 17.380000,
            loop: false
        },
        {
            // Pretty Princess smiled and said
            clipId : 'pretty_princess_smiled_and_said',
            startTime: 237.150000,
            endTime: 240.260000,
            loop: false
        },
        {
            // How shall I ever get to the party on time?
            clipId : 'how_shall_i_ever_get_to_the_party',
            startTime: 97.220000,
            endTime: 100.950000,
            loop: false
        },
        {
            // With this fantastic glowing gown on, I will look extremely elegant.
            clipId : 'with_this_fantastic_glowing_gown',
            startTime: 19.170000,
            endTime: 25.660000,
            loop: false
        },
        {
            // With this stunning, sweet summer dress on, I will look positively dazzling.
            clipId : 'with_this_stunning_sweet_summer_dress',
            startTime: 27.450000,
            endTime: 33.290000,
            loop: false
        },
        {
            // With this terrific, jazzy jumper on, I will look truly chic.
            clipId : 'with_this_terrific_jazzy_jumper',
            startTime: 35.080000,
            endTime: 40.590000,
            loop: false
        },
        {
            // Pretty Princess excitedly cheered
            clipId : 'pretty_princess_excitedly_cheered',
            startTime: 102.740000,
            endTime: 105.760000,
            loop: false
        },
        {
            // On the mystical magic pony, I will definitely not waste time being leisurely.
            clipId : 'on_the_mystical_magic_pony_i_will_definitely',
            startTime: 107.540000,
            endTime: 113.450000,
            loop: false
        },
        {
            // Pretty Princess gleefully exclaimed
            clipId : 'pretty_princess_gleefully_exclaimed',
            startTime: 115.240000,
            endTime: 118.430000,
            loop: false
        },
        {
            // On Count Cloudy's captivating cloud, I will definitely arrive with time to spare.
            clipId : 'on_count_cloudys_captivating_cloud_i_will',
            startTime: 120.220000,
            endTime: 126.880000,
            loop: false
        },
        {
            // Pretty Princess happily declared
            clipId : 'pretty_princess_happily_declared',
            startTime: 128.670000,
            endTime: 131.620000,
            loop: false
        },
        {
            // On the whimsical giant winged puppy, I will definitely reach my destination in style.
            clipId : 'on_the_whimsical_giant_winged_puppy_i_will',
            startTime: 133.410000,
            endTime: 140.000000,
            loop: false
        },


        // other
        {
            // Mused. To muse means to be completely wrapped up in thinking about something. Pretty Princess mused about what would be the perfect gift for the Berry Buddies
            clipId : 'mused_definition',
            startTime: 42.380000,
            endTime: 55.250000,
            loop: false
        },
        {
            // Gasped. To gasp means to breathe suddenly in shock or surprise. Pretty Princess gasped when she realized she was running late to the party.
            clipId : 'to_gasp_means_to',
            startTime: 160.680000,
            endTime: 172.420000,
            loop: false
        },
        {
            // ding
            clipId : 'ding',
            startTime: 310.72000,
            endTime: 313.0000,
            loop: false
        },
	    {
	         // the end
	         clipId : 'the_end',
	         startTime: 320.72000,
	         endTime: 322.0000,
	         loop: false
     },


        // other
        {
            // (one second of silence)
            clipId : '1_second_of_silence',
            startTime: 96.000000,
            endTime: 97.000000,
            loop: false
        },
        {
            // (one half second of silence)
            clipId : '500ms_of_silence',
            startTime: 96.000000,
            endTime: 96.500000,
            loop: false
        },
        {
            // (one second of silence)
            clipId : '1_second_of_silence',
            startTime: 96.000000,
            endTime: 97.000000,
            loop: false
        },
        {
            // 200ms os silence
            clipId : '200ms_of_silence',
            startTime: 96.000000,
            endTime: 96.200000,
            loop: false
        },
        {
            // 750ms os silence
            clipId : '750ms_of_silence',
            startTime: 8.000000,
            endTime: 8.750000,
            loop: false
        },
        {
            // 1 second of silence
            clipId : '1000ms_of_silence',
            startTime: 96.000000,
            endTime: 97.000000,
            loop: false
        }
    ],

    getClip : function(clipId) {
        return _.findWhere(PBS.KIDS.storybook.audio.clips, {
            clipId : clipId
        });
    },

    combineClips : function(clipIds) {
        var self = PBS.KIDS.storybook.audio;
        var soundObj = null;

        // recursively nest the soundObj from the previous iteration into the one from the current iteration
        _.each(clipIds.reverse(), function(clipId, i) {

            // sound object has not been created yet.
            if(!_.isNull(soundObj)) {
                // save the value of "clipId" to find later (answer to {{choice1}}, {{choice2}}, etc)
                if (clipId === '{{choice1}}' || clipId === '{{choice2}}' || clipId === '{{choice3}}') {
                    soundObj = _.extend(
                        { next : soundObj },
                        { calculate : clipId }  // calculate {{choice1}}, {{choice2}}, or {{choice3}}
                    );
                }
                else if (clipId === '{{narration1}}' || clipId === '{{narration2}}' || clipId === '{{narration3}}') {
                    soundObj = _.extend(
                        { next : soundObj },
                        { narration : clipId }
                    );
                }
                // if clip exists
                else {
                    soundObj = _.extend(
                        { next : soundObj },
                        self.getClip(clipId)
                    );
                }
            }
            // if a soundObj hasn't been defined yet, create a new one instead of nesting
            else {
                if (clipId === '{{choice1}}' || clipId === '{{choice2}}' || clipId === '{{choice3}}') {
                    soundObj =  { calculate : clipId };  // calculate {{choice1}}, {{choice2}}, or {{choice3}}
                }
                else if (clipId === '{{narration1}}' || clipId === '{{narration2}}' || clipId === '{{narration3}}') {
                    soundObj =  { narration : clipId };
                }
                else {
                    soundObj = self.getClip(clipId);
                }
            }
        });
        return soundObj;
    },

    playNext : function(soundObj) {
        var self = PBS.KIDS.storybook.audio;

        if(soundObj && soundObj.next && self.player) {

            if(soundObj.next.calculate) {
                var choiceIndex = soundObj.next.calculate.replace(/[^\d]/g, ''); // extracts 1 from {{choice1}}
                var clipId = PBS.KIDS.storybook.choices.getOptionSelectedKey(choiceIndex); // gets the current option selected by the user for choice

                // if a clip id was found for the returned option key, add the audio clip
                if(clipId) {
                    clipId = choiceIndex + clipId;
                    var clip = PBS.KIDS.storybook.audio.getClip(clipId);

                    // a clip matching the generated clipId was found
                    if (clip) {
                        _.extend(soundObj.next, clip);
                        self.player.play(soundObj.next)
                    }
                    else {
                        console.log('could not find sound clip for generated clip ' + clipId);
                        self.playNext(soundObj.next);
                    }
                }

                // otherwise, skip to next item in the chain
                else {
                    console.log('user has not made choice ' + choiceIndex + ' yet');
                    self.playNext(soundObj.next);
                }
            }

            else if(soundObj.next.narration) {
                var choiceIndex = soundObj.next.narration.replace(/[^\d]/g, ''); // extracts 1 from {{narration1}}
                var clipId = PBS.KIDS.storybook.choices.getOptionSelectedKey(choiceIndex); // gets the current option selected by the user for choice

                // narration_1A, narration_2C, etc
                if(clipId) {
                    clipId = choiceIndex + clipId;
                    var clip = self.combineClips(self.narrations['narration_' + clipId]);
                }
                // narration_1_default, narration_2_default, etc
                else {
                    var clip = self.combineClips(self.narrations['narration_' + choiceIndex + '_default']);
                }
                if (clip) {
                    _.extend(soundObj.next, clip);
                    self.player.play(soundObj.next)
                }
                else {
                    console.log('could not find sound clip for generated clip ' + clipId);
                    self.playNext(soundObj.next);
                }
            }

            else {
                self.player.play(soundObj.next)
            }
        }
    }
};