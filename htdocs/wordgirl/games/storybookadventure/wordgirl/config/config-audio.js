PBS.KIDS.storybook.audio = {
    player : {},

    narrations : {
        narration_1_default : [
            'ding'
        ],
        narration_1A : [
            '1000ms_of_silence',
            'the_peaceful_park_bench_provides_cover'
        ],
        narration_1B : [
            '1000ms_of_silence',
            'the_stately_statue_turns'
        ],
        narration_1C : [
            '1000ms_of_silence',
            'ooh_this_towering_tree_provides'
        ],
        narration_2_default : [
            'ding'
        ],
        narration_2A : [
            '1000ms_of_silence',
            'dancing_captain_huggyface_will'
        ],
        narration_2B : [
            '1000ms_of_silence',
            'this_shiny_rock_is_perfect'
        ],
        narration_2C : [
            '1000ms_of_silence',
            'this_adorable_kitten_is_just'
        ],
        narration_3_default : [
            'ding'
        ],
        narration_3A : [
            '1000ms_of_silence',
            'this_serviceable_tire_swing_wrap'
        ],
        narration_3B : [
            '1000ms_of_silence',
            'this_timely_trashcan_bay'
        ],
        narration_3C : [
            '1000ms_of_silence',
            'this_sizable_streetlamp_end'
        ]
    },

    clips : [
        {
            // Battling the Butcher on the city streets, WordGirl is about to be pummeled by a sausage cyclone, one of the Butcher's signature attacks.
            clipId : 'battling_the_butcher',
            startTime: 2.01,
            endTime: 12.790000,
            loop: false
        },
        {
            // This stately statue turns out to be a terrific temporary retreat.
            clipId : 'the_stately_statue_turns',
            startTime: 14.580000,
            endTime: 19.410000,
            loop: false
        },
        {
            // Pummeled. Pummeled means to be punched over and over. WordGirl better watch out, if she isn't careful the Butcher's meat attack will pummel her.
            clipId : 'pummeled_definition',
            startTime: 21.200000,
            endTime: 33.640000,
            loop: false
        },
        {
            // Though WordGirl has avoided the butchers initial attack by diving behind
            clipId : 'though_wordgirl_has_avoided',
            startTime: 35.430000,
            endTime: 41.410000,
            loop: false
        },
        {
            // His meaty onslaught continues
            clipId : 'his_meaty_onslaught_continues',
            startTime: 43.200000,
            endTime: 46.360000,
            loop: false
        },
        {
            // Needing a way to distract the Butcher, WordGirl considers
            clipId : 'needing_a_way_to_distract',
            startTime: 48.150000,
            endTime: 53.180000,
            loop: false
        },{
            // An adorable kitten.
            clipId : '2C',
            startTime: 54.970000,
            endTime: 57.090000,
            loop: false
        },
        {
            // A dancing Captain Huggyface
            clipId : '2A',
            startTime: 58.880000,
            endTime: 61.370000,
            loop: false
        },
        {
            // A shiny rock
            clipId : '2B',
            startTime: 63.150000,
            endTime: 64.870000,
            loop: false
        },
        {
            // What will divert the butchers attention?
            clipId : 'what_will_divert_the_butchers',
            startTime: 66.660000,
            endTime: 68.860000,
            loop: false
        },
        {
            // WordGirl wonders
            clipId : 'wordgirl_wonders',
            startTime: 70.650000,
            endTime: 72.700000,
            loop: false
        },
        {
            // This adorable kitten is just the thing to sidetrack the butcher.
            clipId : 'this_adorable_kitten_is_just',
            startTime: 74.480000,
            endTime: 78.550000,
            loop: false
        },{
            // WordGirl determines
            clipId : 'wordgirl_determines',
            startTime: 80.340000,
            endTime: 82.420000,
            loop: false
        },
        {
            // Dancing Captain Huggyface will befuddle the butcher.
            clipId : 'dancing_captain_huggyface_will',
            startTime: 84.170000,
            endTime: 87.560000,
            loop: false
        },
        {
            // Concludes WordGirl
            clipId : 'concludes_wordgirl',
            startTime: 89.350000,
            endTime: 91.100000,
            loop: false
        },
        {
            // This shiny rock is the perfect diversion.
            clipId : 'this_shiny_rock_is_perfect',
            startTime: 92.850000,
            endTime: 95.590000,
            loop: false
        },
        {
            // Reasons WordGirl
            clipId : 'reasons_wordgirl',
            startTime: 97.380000,
            endTime: 99.200000,
            loop: false
        },
        {
            // Onslaught. Onslaught means a fierce attack. Despite WordGirl's attacks, the Butcher's onslaught continues.
            clipId : 'onslaught_definition',
            startTime: 100.980000,
            endTime: 111.840000,
            loop: false
        },{
            // Divert. Divert means to distract someone by causing them to stop thinking about what they are thinking about. WordGirl needs to distract the Butcher away from his meaty plans.
            clipId : 'divert_means_to_distract_someone',
            startTime: 113.600000,
            endTime: 128.690000,
            loop: false
        },
        {
            // Looking for a place to shield herself from harm, WordGirl surveys the area and sees
            clipId : 'looking_for_a_place_to_shield',
            startTime: 130.480000,
            endTime: 137.750000,
            loop: false
        },
        {
            // Having averted the Butcher's meat attack by ducking behind
            clipId : 'having_averted_the_butchers_meat',
            startTime: 139.540000,
            endTime: 143.590000,
            loop: false
        },
        {
            // WordGirl has now distracted the Butcher with
            clipId : 'wordgirl_has_now_distracted',
            startTime: 145.380000,
            endTime: 148.880000,
            loop: false
        },
        {
            // And is finally ready to apprehend the villain.
            clipId : 'and_is_finally_ready',
            startTime: 150.660000,
            endTime: 154.070000,
            loop: false
        },
        {
            // Searching for something with which to contain the Butcher, WordGirl sees
            clipId : 'searching_for_something',
            startTime: 155.850000,
            endTime: 161.590000,
            loop: false
        },{
            // A sizable street lamp
            clipId : '3C',
            startTime: 163.370000,
            endTime: 165.760000,
            loop: false
        },
        {
            // A serviceable tire swing
            clipId : '3A',
            startTime: 167.550000,
            endTime: 170.140000,
            loop: false
        },
        {
            // A timely trashcan
            clipId : '3B',
            startTime: 171.930000,
            endTime: 173.900000,
            loop: false
        },
        {
            // WordGirl has to think fast
            clipId : 'wordgirl_has_to_think_fast',
            startTime: 175.690000,
            endTime: 177.980000,
            loop: false
        },
        {
            // What can I use to restrain the butcher?
            clipId : 'what_can_i_use_to_restrain',
            startTime: 179.770000,
            endTime: 181.900000,
            loop: false
        },
        {
            // WordGirl is satisfied
            clipId : 'wordgirl_is_satisfied',
            startTime: 183.690000,
            endTime: 186.010000,
            loop: false
        },{
            // This sizable streetlamp will put an end to the butcher's rampage.
            clipId : 'this_sizable_streetlamp_end',
            startTime: 187.790000,
            endTime: 192.050000,
            loop: false
        },
        {
            // WordGirl is contented
            clipId : 'wordgirl_is_contented',
            startTime: 193.840000,
            endTime: 195.960000,
            loop: false
        },
        {
            // This serviceable tire swing is just want i need to wrap things up with the butcher.
            clipId : 'this_serviceable_tire_swing_wrap',
            startTime: 197.750000,
            endTime: 202.470000,
            loop: false
        },
        {
            // WordGirl is appeased
            clipId : 'wordgirl_is_appeased',
            startTime: 204.260000,
            endTime: 206.480000,
            loop: false
        },
        {
            // This timely trashcan will keep the butcher at bay.
            clipId : 'this_timely_trashcan_bay',
            startTime: 208.270000,
            endTime: 211.330000,
            loop: false
        },
        {
            // Restrain. To restrain means to hold someone back. WordGirl needed to think quick. What could she use to best restrain the Butcher?
            clipId : 'restrain_definition',
            startTime: 213.120000,
            endTime: 225.240000,
            loop: false
        },
        {
            // Averted. To avert means to avoid something. WordGirl averted the Butcher's salami storm.
            clipId : 'averted_definition',
            startTime: 227.030000,
            endTime: 235.520000,
            loop: false
        },
        {
            // Emerging from behind
            clipId : 'emerging_from_behind',
            startTime: 237.290000,
            endTime: 239.530000,
            loop: false
        },
        {
            // Emerging from behind
            clipId : 'emerging_from_behind2',
            startTime: 241.320000,
            endTime: 243.560000,
            loop: false
        },
        {
            // WordGirl used
            clipId : 'wordgirl_used',
            startTime: 245.350000,
            endTime: 247.080000,
            loop: false
        },
        {
            // To shackle the Butcher while he was distracted by
            clipId : 'to_shackle_the_butcher',
            startTime: 248.870000,
            endTime: 252.870000,
            loop: false
        },
        {
            // All in a day's work
            clipId : 'all_in_a_days_work',
            startTime: 254.660000,
            endTime: 256.960000,
            loop: false
        },{
            // Word up
            clipId : 'word_up',
            startTime: 258.750000,
            endTime: 260.110000,
            loop: false
        },
        {
            // A peaceful park bench
            clipId : '1A',
            startTime: 261.900000,
            endTime: 264.150000,
            loop: false
        },
        {
            // A towering tree
            clipId : '1C',
            startTime: 265.940000,
            endTime: 267.720000,
            loop: false
        },
        {
            // A stately statue
            clipId : '1B',
            startTime: 269.500000,
            endTime: 271.330000,
            loop: false
        },
        {
            // Hmm, where can i take cover from the butcher's mayhem.
            clipId : 'hmm_where_can_i_take_cover',
            startTime: 273.120000,
            endTime: 276.250000,
            loop: false
        },
        {
            // Shackled. To shackle means to hold someone's wrists or ankles together. WordGirl shackled the Butcher's wrists to save the day.
            clipId : 'shackle_definition',
            startTime: 278.040000,
            endTime: 287.470000,
            loop: false
        },{
            // WordGirl wonders aloud.
            clipId : 'wordgirl_wonders_aloud',
            startTime: 289.260000,
            endTime: 291.640000,
            loop: false
        },
        {
            // WordGirl breathes a sigh of relief.
            clipId : 'wordgirl_breathes_a_sigh',
            startTime: 293.430000,
            endTime: 296.300000,
            loop: false
        },
        {
            // This peaceful park bench provides the perfect cover.
            clipId : 'the_peaceful_park_bench_provides_cover',
            startTime: 298.090000,
            endTime: 301.240000,
            loop: false
        },
        {
            // WordGirl's worries are alleviated
            clipId : 'wordgirls_worries_are_alleviated',
            startTime: 303.030000,
            endTime: 306.210000,
            loop: false
        },
        {
            // Ooh, this towering tree proves to be an ideal hiding spot.
            clipId : 'ooh_this_towering_tree_provides',
            startTime: 308.000000,
            endTime: 311.890000,
            loop: false
        },
        {
            // WordGirl takes a second to relax
            clipId : 'wordgirl_takes_a_second_relax',
            startTime: 313.680000,
            endTime: 316.660000,
            loop: false
        },
        {
            clipId : 'ding',
            startTime: 318.000000,
            endTime: 320.000000,
            loop: false
        },

	    {
		    // Surveys - To survey means to look over something carefully. WordGirl surveyed the park around her to find somewhere safe.
			clipId : 'surveys_definition',
			startTime: 327.390000,
			endTime: 337.950000,
			loop: false
        },
	    {
		    // Apprehend – To apprehend means to catch someone and restrain them. WordGirl is ready to catch the Butcher!
			clipId : 'apprehend_definition',
			startTime: 339.740000,
			endTime: 349.100000,
			loop: false
        },
	    {
		    // Emerging – To emerge means to come out from where you couldn’t be seen. WordGirl emerged from where she was hiding.
			clipId : 'emerging_definition',
			startTime: 350.740000,
			endTime: 360.680000,
			loop: false
        },

        // other
        {
            // (one second of silence)
            clipId : '1_second_of_silence',
            startTime: 138.000000,
            endTime: 139.000000,
            loop: false
        },
        {
            // 200ms os silence
            clipId : '200ms_of_silence',
            startTime: 138.000000,
            endTime: 138.200000,
            loop: false
        },
        {
            // 500ms os silence
            clipId : '500ms_of_silence',
            startTime: 138.000000,
            endTime: 138.500000,
            loop: false
        },
        {
            // 750ms os silence
            clipId : '750ms_of_silence',
            startTime: 138.000000,
            endTime: 138.750000,
            loop: false
        },
        {
            // 1 second of silence
            clipId : '1000ms_of_silence',
            startTime: 138.000000,
            endTime: 139.000000,
            loop: false
        }
    ],


    getClip : function(clipId) {
        return _.findWhere(PBS.KIDS.storybook.audio.clips, {
            clipId : clipId
        });
    },

    combineClips : function(clipIds) {
        var self = PBS.KIDS.storybook.audio;
        var soundObj = null;

        // recursively nest the soundObj from the previous iteration into the one from the current iteration
        _.each(clipIds.reverse(), function(clipId, i) {

            // sound object has not been created yet.
            if(!_.isNull(soundObj)) {
                // save the value of "clipId" to find later (answer to {{choice1}}, {{choice2}}, etc)
                if (clipId === '{{choice1}}' || clipId === '{{choice2}}' || clipId === '{{choice3}}') {
                    soundObj = _.extend(
                        { next : soundObj },
                        { calculate : clipId }  // calculate {{choice1}}, {{choice2}}, or {{choice3}}
                    );
                }
                else if (clipId === '{{narration1}}' || clipId === '{{narration2}}' || clipId === '{{narration3}}') {
                    soundObj = _.extend(
                        { next : soundObj },
                        { narration : clipId }
                    );
                }
                // if clip exists
                else {
                    soundObj = _.extend(
                        { next : soundObj },
                        self.getClip(clipId)
                    );
                }
            }
            // if a soundObj hasn't been defined yet, create a new one instead of nesting
            else {
                if (clipId === '{{choice1}}' || clipId === '{{choice2}}' || clipId === '{{choice3}}') {
                    soundObj =  { calculate : clipId };  // calculate {{choice1}}, {{choice2}}, or {{choice3}}
                }
                else if (clipId === '{{narration1}}' || clipId === '{{narration2}}' || clipId === '{{narration3}}') {
                    soundObj =  { narration : clipId };
                }
                else {
                    soundObj = self.getClip(clipId);
                }
            }
        });
        return soundObj;
    },

    playNext : function(soundObj) {
        var self = PBS.KIDS.storybook.audio;

        if(soundObj && soundObj.next && self.player) {

            if(soundObj.next.calculate) {
                var choiceIndex = soundObj.next.calculate.replace(/[^\d]/g, ''); // extracts 1 from {{choice1}}
                var clipId = PBS.KIDS.storybook.choices.getOptionSelectedKey(choiceIndex); // gets the current option selected by the user for choice

                // if a clip id was found for the returned option key, add the audio clip
                if(clipId) {
                    clipId = choiceIndex + clipId;
                    var clip = PBS.KIDS.storybook.audio.getClip(clipId);

                    // a clip matching the generated clipId was found
                    if (clip) {
                        _.extend(soundObj.next, clip);
                        self.player.play(soundObj.next)
                    }
                    else {
                        console.log('could not find sound clip for generated clip ' + clipId);
                        self.playNext(soundObj.next);
                    }
                }

                // otherwise, skip to next item in the chain
                else {
                    console.log('user has not made choice ' + choiceIndex + ' yet');
                    self.playNext(soundObj.next);
                }
            }

            else if(soundObj.next.narration) {
                var choiceIndex = soundObj.next.narration.replace(/[^\d]/g, ''); // extracts 1 from {{narration1}}
                var clipId = PBS.KIDS.storybook.choices.getOptionSelectedKey(choiceIndex); // gets the current option selected by the user for choice

                // narration_1A, narration_2C, etc
                if(clipId) {
                    clipId = choiceIndex + clipId;
                    var clip = self.combineClips(self.narrations['narration_' + clipId]);
                }
                // narration_1_default, narration_2_default, etc
                else {
                    var clip = self.combineClips(self.narrations['narration_' + choiceIndex + '_default']);
                }
                if (clip) {
                    _.extend(soundObj.next, clip);
                    self.player.play(soundObj.next)
                }
                else {
                    console.log('could not find sound clip for generated clip ' + clipId);
                    self.playNext(soundObj.next);
                }
            }

            else {
                self.player.play(soundObj.next)
            }
        }
    }
};