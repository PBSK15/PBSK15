"use strict";var PxSoundControl=function(){this._wa_sound=null,this._at_sound=null};PxSoundControl.prototype.stop=function(){null!==this._wa_sound?this._wa_sound.stop?this._wa_sound.stop(PxAudio._instance.context.currentTime+0):this._wa_sound.noteOff&&this._wa_sound.noteOff(PxAudio._instance.context.currentTime+0):null!==this._at_sound&&(this._at_sound.pause(),this._at_sound.currentTime=0)};var PxAudio=function(){};PxAudio.logging=!0,PxAudio.log=function(o){PxAudio.logging&&"undefined"!=typeof console&&"undefined"!=typeof console.log&&console.log(o)},PxAudio.getSupportedFormats=function(){if(null!==PxAudio._supportedFormats)return PxAudio._supportedFormats;var o=document.createElement("audio");return PxAudio._supportedFormats=o?{mp3:!(!o.canPlayType||!o.canPlayType("audio/mpeg;").replace(/no/,"")),ogg:!(!o.canPlayType||!o.canPlayType("audio/ogg;").replace(/no/,""))}:{},PxAudio._supportedFormats},PxAudio.getInstance=function(o){if(PxAudio._instance)return PxAudio._instance;var t=null;if(PxAudio.WebAudio=window.AudioContext)PxAudio.log("acquired AudioContext"),t="webaudio";else if(PxAudio.WebAudio=window.webkitAudioContext)PxAudio.log("acquired webkitAudioContext"),t="webaudio";else{if(PxAudio.log("WebAudio not supported"),!window.Audio)return PxAudio.log("Audio tag not supported"),PxAudio.log("no Audio API available"),null;t="audiotag",PxAudio.log("using Audio tag")}var a=PxAudio.getSupportedFormats();a.mp3&&PxAudio.log("mp3 supported"),a.ogg&&PxAudio.log("ogg supported");var e=new PxAudio;e.api=t,e.support=a,"webaudio"===t?e.context=new PxAudio.WebAudio:o.b64&&(e.b64=!0),e.sounds={},e.volume=1,e.minDelay=o.minDelay||0,e.sameDelay=o.sameDelay||0;var n=o.preferFormat||"mp3";if(n=n.toLowerCase(),"mp3"!==n&&"ogg"!==n&&(PxAudio.log("Unrecognized preferFormat: '"+n+"' defaulting to mp3."),n="mp3"),e.preferFormat=n,a[n])e.format=n;else if(a.mp3)e.format="mp3";else{if(!a.ogg)return PxAudio.log("couldn't select an audio format!"),null;e.format="ogg"}return PxAudio.log("selected "+e.format+" format"),e.prevPlayT=0,e.loadCount=0,e.loadTotal=0,e.loadedCallback=null,e.loadErrCallback=null,e.loadProgressCallback=null,PxAudio._instance=e,e},PxAudio.WebAudio=null,PxAudio.prototype.loadSounds=function(o,t,a,e){for(var n in o)o.hasOwnProperty(n)&&++this.loadTotal;if(this.loadTotal<1)return void PxAudio.log("No sounds to load.");this.loadedCallback=t,this.loadErrCallback=a,this.loadProgressCallback=e;for(var n in o)o.hasOwnProperty(n)&&("webaudio"===this.api?this._loadSound_wa(n,o[n]+"."+this.format):"audiotag"===this.api&&(this.b64?this._loadSound_at_b64(n,o[n]+"."+this.format+".txt"):this._loadSound_at(n,o[n]+"."+this.format)))},PxAudio.prototype.playSound=function(o,t,a){var e=this.sounds[o];if(!e)return void console.error("Unrecognized sound name:",o);var n=(new Date).getTime();if(!(n-this.prevPlayT<this.minDelay||n-e.prevPlayT<this.sameDelay)){"undefined"==typeof t?t=1:0>t?t=0:t>1&&(t=1);var i=null;return"webaudio"===this.api?i=this._playSound_wa(e,t,a):"audiotag"===this.api&&(i=this._playSound_at(e,t,a)),e.prevPlayT=n,this.prevPlayT=n,i}},PxAudio.prototype.stopSound=function(){},PxAudio.prototype.pauseSound=function(){},PxAudio.prototype.setVolume=function(o){o="number"==typeof o?Math.max(Math.min(o,1),0):0,this.volume=o},PxAudio._instance=null,PxAudio._supportedFormats=null,PxAudio.prototype._playSound_wa=function(o,t,a){var e=null,n=this.context.createBufferSource();return a&&(n.loop=!0),e=new PxSoundControl,e._wa_sound=n,n.buffer=o.buffer,n.connect(this.context.destination),n.start?n.start(0):n.noteOn&&n.noteOn(0),e},PxAudio.prototype._playSound_at=function(o){this.b64&&(o.atag.src=o.b64data),o.atag.play();var t=new PxSoundControl;return t._at_sound=o.atag,t},PxAudio.prototype._loadSound_wa=function(o,t){var a=new XMLHttpRequest;a.open("GET",t,!0),a.responseType="arraybuffer";var e=this;a.onload=function(){e.context.decodeAudioData(a.response,function(a){return a?(e.sounds[o]={buffer:a,prevPlayT:0},void e._onLoadProgress(t)):void e._onLoadErr("error decoding audio file: "+t)},function(o){e._onLoadErr("decodeAudioData error for file '"+t+"': "+o)})},a.onerror=function(){e._onLoadErr("error loading file: "+t+" ("+a.status+")")},a.send()},PxAudio.prototype._loadSound_at=function(o,t){var a=new Audio,e=this;a.addEventListener("loadeddata",function(){e._onLoadProgress(t)}),this.sounds[o]={atag:a,prevPlayT:0},a.src=t,a.load()},PxAudio.prototype._loadSound_at_b64=function(o,t){var a="text/plain",e=null,n=this,i="mp3"===this.format?"mpeg":"ogg",d="data:audio/"+i+";base64,";if(window.XMLHttpRequest)e=new XMLHttpRequest,e.overrideMimeType&&e.overrideMimeType(a);else if(window.ActiveXObject)try{e=new ActiveXObject("Msxml2.XMLHTTP")}catch(u){try{e=new ActiveXObject("Microsoft.XMLHTTP")}catch(u){}}return e?(e.onreadystatechange=function(){4==e.readyState&&(200==e.status?(n.sounds[o]={atag:new Audio,b64data:d+e.responseText,prevPlayT:0},n._onLoadProgress(t)):n._onLoadErr("error loading file: "+t+" ("+e.status+")"))},e.open("GET",t,!0),void e.send()):void console.error("This browser does not support AJAX.")},PxAudio.prototype._onAllLoaded=function(){this.loadErrCallback=null,this.loadProgressCallback=null,this.loadCount=0,this.loadTotal=0,this.loadedCallback&&this.loadedCallback(),this.loadedCallback=null},PxAudio.prototype._onLoadErr=function(o){console.error(o),this.loadErrCallback&&this.loadErrCallback(o),this.loadErrCallback=null,this.loadedCallback=null},PxAudio.prototype._onLoadProgress=function(o){PxAudio.log("loaded '"+o+"'"),++this.loadCount,this.loadProgressCallback&&this.loadProgressCallback(1*this.loadCount/this.loadTotal),this.loadCount===this.loadTotal&&this._onAllLoaded()};